/*! neo-bugreiro 18-04-2018 */

var MAX_FOLKS=8,AntifaController=function(){this.deadFolkPlaces=[],this.deadCount=0,this.fascistMode=!0,this.naziChoices=0,this.naziCount=0,this.antifaCount=0,this.killedFirstFolk=!1,this.firstShoot=!1,this.peace=!0},GameEnvironment=function(){this.map=null,this.folks=[],this.player=null,this.endGame=0,this.tribeArea=null,this.largeTribeArea=null,this.safePoints=null,this.removeFolk=function(t){var i=this.folks.indexOf(t);this.folks.splice(i,1),t.behavior=null},this.clear=function(){this.map=null,this.folks.length=0,this.player=null,this.endGame=0}},Environment=new GameEnvironment,AntifaControl=new AntifaController,Heuristic={manhattan:function(t,i){return 10*(Math.abs(i.x-t.x)+Math.abs(i.y-t.y))},euclidean:function(t,i){return 0},octagonal:function(t,i){return 0}},PathMovementCost=[14,10,14,10,0,10,14,10,14],PathDirections=[{x:0,y:1},{x:1,y:0},{x:0,y:-1},{x:-1,y:0},{x:-1,y:-1},{x:1,y:1},{x:-1,y:1},{x:1,y:-1}],PathNode=function(t,i){null==t&&(t={x:0,y:0}),this.position=t,this.parent=i||null,this.direction=null,this.G=0,this.H=0,this.Score=function(){return this.G+this.H}},PathFinding=function(t,i,e){this.map=i,this.movementDirections=t||4,this.collisionPredicate=e||null,this.FindNode=function(t,i){for(var e=t.content(),s=0;s<e.length;s++)if(e[s].position.x==i.x&&e[s].position.y==i.y)return e[s];return null},this.FindPath=function(t,i,e,s){var o=new scintilla.Structure.List(null,!1),n=new scintilla.Structure.List(null,!1);if(void 0!==this.collisionPredicate){var l,a,h=null,r={x:0,y:0},d=new PathNode(t,null);n.push(d);for(var c,u=0;!n.empty();){if(c=n.first(),null===(h=n.each(function(t){if(t.Score()<=c.Score())return t})||c))break;if(h.position.x===i.x&&h.position.y===i.y)break;for(o.push(h),n.erase(h),a=0;a<this.movementDirections;a++)if(r.x=h.position.x+PathDirections[a].x,r.y=h.position.y+PathDirections[a].y,!(r.x<0||r.x>=this.map.width||r.y<0||r.y>=this.map.height||null!==this.FindNode(o,r))&&!1===this.collisionPredicate(r,e)){l=h.G+(a<4?10:14);var p=this.FindNode(n,r);null===p?((p=new PathNode(r,h)).direction=PathDirections[a],p.G=l,p.H=Heuristic.manhattan(r,i),n.push(p)):l<p.G&&(p.parent=h,p.G=l)}u++}return console.log(u),o.clear(),n.clear(),h}console.warn("Error")}},PathFinder=new PathFinding(4);function CheckMapCollision(t,i){if(i<0)return!0;if(t<0)return!1;if(t>=Environment.map.width||i>=Environment.map.height)return!0;var e=Environment.map.layers[1].getTile(t,i);return null===e||e.data.properties.colliadable}function CollidesWithFolk(t,i,e){var s;void 0===e&&(e=!0);for(var o=0;o<Environment.folks.length;o++)if(!0!==(s=Environment.folks[o]).dead){if(s.tile.x===t&&s.tile.y===i)return s;if(!0===e&&!0===s.isMoving){if(s.toTile.x===t&&s.toTile.y===i)return s;if(s.oldTile.x===t&&s.oldTile.y===i)return s}}return null}function CheckFolkCollision(t,i,e){for(var s,o=!0,n=0;n<Environment.folks.length;n++)if(o=!0,s=Environment.folks[n],void 0!==e&&(o=!(s.id===e||!0===s.dead)),!1!==o){if(s.tile.x===t&&s.tile.y===i)return s;if(s.oldTile.x===t&&s.oldTile.y===i)return s;if(s.toTile.x===t&&s.toTile.y===i)return s}return null}function CheckDirectionalCollision(t,i,e){e[0]=!CheckMapCollision(t.x+1,t.y)&&!CheckFolkCollision(t.x+1,t.y,i)&&!CollideWithPlayer(t.x+1,t.y),e[1]=!CheckMapCollision(t.x-1,t.y)&&!CheckFolkCollision(t.x-1,t.y,i)&&!CollideWithPlayer(t.x-1,t.y),e[2]=!CheckMapCollision(t.x,t.y-1)&&!CheckFolkCollision(t.x,t.y-1,i)&&!CollideWithPlayer(t.x,t.y-1),e[3]=!CheckMapCollision(t.x,t.y+1)&&!CheckFolkCollision(t.x,t.y+1,i)&&!CollideWithPlayer(t.x,t.y+1),e[4]=!(e[0]||e[1]||e[2]||e[3])}function CollideWithPlayer(t,i){return Environment.player.tile.x==t&&Environment.player.tile.y==i||(Environment.player.oldTile.x==t&&Environment.player.oldTile.y==i||Environment.player.toTile.x==t&&Environment.player.toTile.y==i)}function CollideWith(t,i){return t.tile.x==i.tile.x&&t.tile.y==i.tile.y||(t.toTile.x==i.toTile.x&&t.toTile.y==i.toTile.y||(t.toTile.x==i.tile.x&&t.toTile.y==i.tile.y||i.toTile.x==t.tile.x&&i.toTile.y==t.tile.y))}function SetToTile(t,i,e){t.position.set(scintilla.Math.round(16*i)+16*t.origin.x,scintilla.Math.round(16*e)+16*t.origin.y)}function GetEntityTile(t){return{x:Math.round((t.x+16*t.origin.x)/16),y:Math.round((t.y+16*t.origin.y)/16)}}function GetTile(t,i){return{x:Math.round(t/16),y:Math.round(i/16)}}function WorldToTile(t,i,e){e.x=Math.round(t/16),e.y=Math.round(i/16)}function RoundToTile(t){SetToTile(t,(t.x-16*t.origin.x)/16,(t.y-16*t.origin.y)/16)}function CameraFollowPlayer(t,i){var e=i.x-144;e<=0&&(e=0),t.x=e}function CreateTiledEntity(t,i){t.spd=i||25,t.spdDuration=16/i,t.moveTimer=0,t.isMoving=!1,t.hspd=0,t.vspd=0,t.oldPos={x:0,y:0},t.destPos={x:0,y:0},t.oldTile={x:0,y:0},t.toTile={x:0,y:0},t.tile=GetTile(t.x-8,t.y-8),t.beingSmart=!1}function ActiveTileMovement(t,i,e){t.isMoving=!0,t.moveTimer=0,t.oldPos.x=t.x,t.oldPos.y=t.y,t.toTile.x=t.oldTile.x+i,t.toTile.y=t.oldTile.y+e}function TileMovement(t,i){t.moveTimer+=i/t.spdDuration,1<=t.moveTimer&&(t.isMoving=!1,t.moveTimer=1),0!==t.hspd&&(t.x=scintilla.Math.lerp(t.oldPos.x,t.destPos.x,t.moveTimer)),0!==t.vspd&&(t.y=scintilla.Math.lerp(t.oldPos.y,t.destPos.y,t.moveTimer)),WorldToTile(t.x-8,t.y-8,t.tile),t.isMoving||(t.x=t.destPos.x,t.y=t.destPos.y,RoundToTile(t))}function GetNearestSafePoint(t){return{x:0,y:0}}function PathFindCollisionTest(t,i){return!CheckMapCollision(t.x,t.y)}function ActivePathNodeMovement(t,i){var e=0;return t.toTile.x=i.position.x,t.toTile.y=i.position.x,t.oldPos.x=t.x,t.oldPos.y=t.y,t.hspd=i.position.x-t.tile.x,t.vspd=i.position.y-t.tile.y,0!==t.hspd?(t.vspd=0,e=t.hspd):0!==t.vspd&&(t.hspd=0,e=1===t.vspd?2:3),t.destPos.x=Math.round(16*i.position.x+8),t.destPos.y=Math.round(16*i.position.y+8),t.isMoving=!0,t.beingSmart=!0,t.moveTimer=0,e}function ValidatePathNode(){}function TileMovementThroughPathNode(t,i,e){if(i.moveTimer+=e/i.spdDuration,1<=i.moveTimer&&(i.moveTimer=1,i.isMoving=!1),0!==i.hspd&&(i.x=scintilla.Math.lerp(i.oldPos.x,i.destPos.x,i.moveTimer)),0!==i.vspd&&(i.y=scintilla.Math.lerp(i.oldPos.y,i.destPos.y,i.moveTimer)),WorldToTile(i.x-8,i.y-8,i.tile),!1===i.isMoving){var s=t.parent;if(null!==s){var o=ActivePathNodeMovement(i,s);t=t.parent,ChangeFolkState(i,o)}else t=null,i.x=i.destPos.x,i.y=i.destPos.y,RoundToTile(i)}}var bloodFrame={x:64,y:64,width:16,height:16},FolkBehavior={Still:0,LeftRight:1,UpDown:2,Random:3,PathFinding:4};function ChangeFolkState(t,i){void 0===i&&(i=t.dir);var e="",s=1;switch(i){case 0:e="side";break;case 1:e="side",s=-1;break;case 2:e="up";break;case 3:e="down"}t.scale.x!==s&&(t.scale.x=s),t.dir=i,t.animMachine.setState("folk_"+e+"_"+t.id.toString()),!1===t.animMachine.isPlaying&&t.animMachine.play()}function PreventFolkToGoToEnemy(t,i){var e=Math.abs(t.tile.x-Environment.player.tile.x),s=Math.abs(t.tile.y-Environment.player.tile.y);if(0===i){if(t.tile.x+1-Environment.player.tile.x<0)return!1}else if(1===i){if(e<10&&Environment.player.tile.x-(t.tile.x-1)<=0)return!1}else if(2==i){if(s<3&&Environment.player.tile.y-(t.tile.y-1)<0)return!1}else if(3==i&&s<3&&t.tile.y+1-Environment.player.tile.y<0)return!1;return!0}function RandomizeFolkDirection(t){var i=[],e=0;for(e=0;e<4;e++)!0===t.tileDirection[e]&&!0===PreventFolkToGoToEnemy(t,e)&&i.push(e);if(0<i.length){var s=scintilla.Random.integerRange(0,i.length);(s=i[s])<=1?(t.hspd=1===s?-1:1,t.vspd=0):(t.vspd=3===s?1:-1,t.hspd=0)}else t.vspd=0,t.hspd=0;return s}function Folk(){this.animMachine=null,this.behavior=FolkBehavior.Random,this.spr=null,this.tile=null,this.dead=!1,this.id=0,this.dir=0,this.tileDirection=[!1,!1,!1,!1,!1],this.smartness=100;var o=0,n=null,l=!1,a=null;this.start=function(){CreateTiledEntity(this,25),(n=this.scene.create.spritesheet("alert")).modules.get("render").depth=12,n.active=!1,this.animMachine=this.modules.attach.animMachine(),this.origin.set(.5,.5),this.spr=this.modules.get("render"),this.spr.depth=2},this.update=function(t){if(!0!==this.dead&&(!1!==AntifaControl.killedFirstFolk||!0!==AntifaControl.peace))if(!1===l&&(l=!0,n.active=!0),o<=0){if(!1===this.isMoving){if(null===this.behavior)return;var i=!0;WorldToTile(this.x-8,this.y-8,this.tile),this.oldTile.x=this.tile.x,this.oldTile.y=this.tile.y;var e=0;if(!0===i){var s=GetNearestSafePoint(this.position);null!==(a=PathFinder.FindPath(this.oldTile,s,this))?ChangeFolkState(this,e=ActivePathNodeMovement(this,a)):i=!1}!1===i&&(this.beingSmart=!1,CheckDirectionalCollision(this.tile,this.id,this.tileDirection),!0===this.tileDirection[4]?o=2:(e=RandomizeFolkDirection(this),0!=this.hspd&&-this.hspd,ChangeFolkState(this,e),this.destPos.x=Math.round(this.x+16*this.hspd),this.destPos.y=Math.round(this.y+16*this.vspd),ActiveTileMovement(this,this.vspd,this.hspd)))}this.isMoving&&(!1===this.beingSmart?TileMovement(this,t):TileMovementThroughPathNode(a,this,t)),n.x=this.x-8,n.y=this.y-12}else o-=t},this.Setup=function(t,i,e,s,o,n){this.player=n,this.position.set(t+8,i+8),this.tile=GetTile(this.x,this.y),this.id=e},this.Die=function(){this.dead=!0,this.animMachine.stop(),this.scene.entity.destroy(n);var t=this.id%2*16,i=16*scintilla.Math.floor(this.id/2);this.spr.setFrame(96+t,48+i,16,16);var e=this.scene.create.sprite("chars","blood",bloodFrame);e.position.set(this.x-8,this.y-8),this.spr.depth=1,e.modules.get("render").depth=0,alphaTime=0,AntifaControl.naziCount++}}function ShootEffect(){var s;this.vspd=0,this.hspd=1,this.start=function(){s=this.modules.attach.spritesheet("shoot_effect_side"),this.modules.get("render").depth=7,s.loop=!1,s.onAnimationEnd=this.end,this.origin.set(.5,.5)},this.end=function(){this.back()},this.setup=function(t,i){switch(i){case 0:case 1:var e=1===i?1:-1;s.animation="shoot_effect_side",this.x=t.x+15*e,this.y=t.y,this.scale.x=e;break;case 2:case 3:s.animation="shoot_effect_updown";e=2===i?1:0;this.x=t.x+4*e,this.y=t.y+8*-e,this.scale.x=1}s.restart()}}function BulletExplosion(){this.anim=null,this.start=function(){this.anim=this.modules.attach.spritesheet("bullet_explosion"),this.modules.get("render").depth=8,this.anim.loop=!1,this.anim.onAnimationEnd=this.back,this.origin.set(.5,.5)}}function BloodEffect(){this.folkToDie=null,this.start=function(){var t=this.modules.attach.spritesheet("blood_explosion");this.modules.get("render").depth=9,t.onAnimationEnd=function(){this.scene.entity.destroy(this),this.folkToDie.Die()},t.loop=!1,this.origin.set(.5,.5)},this.update=function(){this.position.set(this.folkToDie.x,this.folkToDie.y)}}var BULLET_SPD=100;function Bullet(){this.vspd=0,this.hspd=1,this.effect=null,this.moduleAnim=null;var s,o={x:this.t=0,y:0};this.tile={x:0,y:0},this.start=function(){s=this.modules.attach.sprite("chars",64,48,16,16),this.origin.set(.5,.5)},this.Explode=function(t){var i=this.scene.pool.pull("explosion");(i.anim.restart(),i.position.set(this.x,this.y),void 0===t||t.dead)?this.scene.audio.playOnce("explosion"):(this.scene.entity.create(BloodEffect).folkToDie=t,this.scene.audio.playOnce("dead"),Environment.removeFolk(t),AntifaControl.killedFirstFolk=!0);this.back()},this.update=function(t){if(this.x+=this.hspd*BULLET_SPD*t,this.y+=this.vspd*BULLET_SPD*t,!0===AntifaControl.peace&&!0===Environment.player.reachTheTribe&&Environment.tribeArea.intersects(this.x-8,this.y-8,16,16)&&(AntifaControl.peace=!1),this.scene.camera.isCulled(s)){WorldToTile(this.x-8,this.y-8-o.y,this.tile);var i=CollidesWithFolk(this.tile.x,this.tile.y,!1);null===i?CheckMapCollision(this.tile.x,this.tile.y)&&this.Explode():this.Explode(i)}else this.back()},this.setup=function(t,i){var e=1;switch(i){case 0:case 1:e=1===i?1:-1,this.vspd=0,this.hspd=e,o.x=0,o.y=1,this.x=t.x+8*e,this.y=t.y+o.y,this.scale.x=e,this.angle=0;break;case 2:case 3:e=3===i?1:-1,this.vspd=e,this.hspd=0,o.y=4*e,this.x=t.x,this.y=t.y+o.y,this.scale.x=1,this.angle=1===e?90:270}s.depth=6}}function SceneLogo(){this.waitLogoTime=0,this.done=!0,this.goToScene="title",this.preload=function(){this.load.setPath("assets/"),this.load.webFont("font","google","Press Start 2P"),this.load.image("titleNeo","img/n_title_neo.png"),this.load.image("titleBugre","img/n_title_bugre.png"),this.load.image("titleBugreBack","img/n_title_bugre_fill.png"),this.load.image("titleBorder","img/n_title_bugre_border.png"),this.load.image("titleChroma","img/n_title_chrome.bmp"),this.load.image("titleBg","img/n_title_bg.bmp"),this.load.image("antifaJamLogo","img/antifagamejamlogo.png"),this.load.audio("titleMusic","sfx/505-loop3.ogg"),this.load.audio("gameMusic","sfx/505-myth.ogg"),this.load.audio("ok","sfx/n_confirm.wav"),this.load.audio("shoot","sfx/n_shot.wav"),this.load.audio("explosion","sfx/n_explosion.wav"),this.load.audio("dead","sfx/n_dead.wav"),this.load.tilemapJSON("tilemap","map/n_tilemap.json"),this.load.image("chars","img/n_chars.png"),this.load.spritesheet("bug_down","chars",[0,0,16,16,2],123),this.load.spritesheet("bug_side","chars",[0,16,16,16,2],123),this.load.spritesheet("bug_up","chars",[0,32,16,16,2],123),this.load.spritesheet("bug_shoot_down","chars",[32,0,16,16,4],120),this.load.spritesheet("bug_shoot_side","chars",[32,16,16,16,4],120),this.load.spritesheet("bug_shoot_up","chars",[32,32,16,16,4],120),this.load.animMachine("bugreiro",["bug_down","bug_side","bug_up","bug_shoot_down","bug_shoot_side","bug_shoot_up"]),this.load.spritesheet("shoot_effect_side","chars",[96,0,16,16,3,1],120),this.load.spritesheet("shoot_effect_updown","chars",[112,0,16,16,3,1],120),this.load.spritesheet("bullet_explosion","chars",[128,0,16,16,4,1],120),this.load.spritesheet("blood_explosion","chars",[80,48,16,16,5,1],160),this.load.spritesheet("alert","chars",[64,80,16,16,4,1],123);for(var t,i,e,s=0,o=48,n=0,l=0;l<MAX_FOLKS;l++)t="folk_down_"+l.toString(),e="folk_side_"+l.toString(),i="folk_up_"+l.toString(),this.load.spritesheet(t,"chars",[s,o,16,16,2],240),this.load.spritesheet(e,"chars",[s,o+16,16,16,2],240),this.load.spritesheet(i,"chars",[s,o+32,16,16,2],240),this.load.animMachine("folk_"+l.toString(),[t,e,i]),2<=++n?(s=n=0,o+=48):s+=32;this.events.subscribe("asset_complete",function(t,i){if(i===scintilla.AssetType.spritesheet){/^bug_shoot_/.test(t.name)?(t.loop=!1,t.duration=120,t.duplicate(0)):/^bug_/.test(t.name)&&(t.loop=!0,t.duration=160)}})},this.start=function(){this.transition.settings.setOutDuration(1),this.transition.settings.setEaseOutMethod(scintilla.Ease.Type.CUT,3),this.transition.settings.setEaseInMethod(scintilla.Ease.Type.CUT,3),this.transition.out(),"title"===this.goToScene&&this.audio.playPersistent("titleMusic",.3,!0)},this.update=function(t){this.done?this.scene.set(this.goToScene):(this.waitLogoTime+=t/2.5,1<=this.waitLogoTime&&(this.transition.settings.setInDuration(1),this.done=!0))},this.gui=function(t){t.sprite("antifaJamLogo",160,120,.5,.5)}}function SceneTitle(){this.blinkStartTime=0,this.blinkStart=!1;var n=0,l=0,s=0,o=0,a=176.5,h=1,r=!1,d=0,c=0,u=null;this.start=function(){this.transition.out()},this.update=function(t){if(0===c){var i=this.key.pressed(scintilla.KeyCode.Enter)||this.key.pressed(scintilla.KeyCode.Space);if(r)(this.key.pressed(scintilla.KeyCode.Up)||this.key.pressed(scintilla.KeyCode.Down))&&(this.audio.playOnce("ok",.5),d=!d),i&&(this.transition.in(),this.audio.playOnce("ok",.5),this.blinkStartTime=0,u=this.audio.at(0),this.events.subscribeOnce("transition_end",function(){c=2}),c=1);else this.blinkStartTime+=t,.5<=this.blinkStartTime&&(this.blinkStart=!this.blinkStart,this.blinkStartTime=0),i&&(r=!0,this.audio.playOnce("ok",.5))}else if(2===c){this.blinkStartTime+=t;var e=this.blinkStartTime/1.5;1<=e&&(e=1),u.volume=scintilla.Math.lerp(.3,0,e),2<=this.blinkStartTime&&(this.audio.stopAll(!0),this.scene.set("game"))}1<=(s+=t/6)&&(s=0),o=scintilla.Math.toRadian*(360*s),n=Math.cos(o),l=Math.sin(o)},this.gui=function(t){var i,e;t.defaultComposite(),t.sprite("titleChroma",a,81.5,.5,.5),t.composite="destination-in",t.spriteSkew("titleBugre",a,81.5,.05*n,.05*-l,.5,.5),t.composite="destination-over";for(var s=.05*Math.atan(l),o=.05*Math.atan(n);h<4;h++)i=80*h,e=64*h,t.alpha=scintilla.Math.lerp(1,0,(h-1)/3),t.spriteSkew("titleBugreBack",a+i*o,81.5+e*s,.05*n,.05*-l,.5,.5);t.alpha=1,h=1,t.sprite("titleBg",0,0),t.defaultComposite(),t.spriteSkew("titleBorder",a+n,81.5+l,.05*n,.05*-l,.5,.5),t.sprite("titleNeo",14+4*n,4-3*l+12),t.font("Press Start 2P",8),t.color="#fff",r?(t.align="center",t.text("FAIR EXCHANGE?",160,148),t.align="left",t.text(">",132,164+12*d),t.text("YES",148,164),t.text("NO",148,176)):(t.align="center",this.blinkStart&&t.text("PRESS START",160,164),t.align="left"),t.text("TOBIASBU",8,232),t.text("MUSIC BY 505",8,222),t.align="right",t.text("2018",312,232)}}function InitializeFascistMode(){}function RandomizeFolksParameters(t){for(var i=0,e=0;e<t.length;e++){var s=t[e];scintilla.Random.integerRange(0,100)<30&&i<2?(s.spd=25,i++):s.spd=50,s.spdDuration=16/s.spd,s.animMachine.machine.duration=s.spdDuration/2*1e3}}function InstantiateFolks(t,i){for(var e,s=i.getObjectsLayer("FolkSpawn").objects,o=s.length,n=[],l=[],a=0;a<MAX_FOLKS;a++){var h;for((e=t.entity.create(Folk)).animMachine.machine="folk_"+a.toString();;){var r=!1,d=scintilla.Random.integerRange(0,o);if(0!==n.length)for(var c=0;c<n.length;c++)if(n[c]===d){r=!0;break}if(!1===r){h=s[d],n.push(d);break}}e.Setup(h.x,h.y,a),l.push(e)}RandomizeFolksParameters(l),Environment.folks=l}function SceneGame(){var i,e,s=0,o=0,n=!1,l=0,a=0,h=0,r=0,d=0;this.start=function(){this.transition.out(),this.audio.play("gameMusic",.3,!0),this.pool.create("bullet",Bullet,10),this.pool.create("bullet_efx",ShootEffect,10),this.pool.create("explosion",BulletExplosion,10);var t=this.create.tilemap("tilemap");e=t.modules.get("render"),Environment.map=e,Environment.largeTribeArea=e.getObjectsLayer("FolkTribe").objects[0],Environment.tribeArea=e.getObjectsLayer("FolkTribe").objects[1],Environment.safePoints=e.getObjectsLayer("SafePoints").objects,PathFinder.map=e,PathFinder.collisionPredicate=PathFindCollisionTest,i=this.entity.create(Player),Environment.player=i,InstantiateFolks(this,e)},this.update=function(t){CameraFollowPlayer(this.camera,i),this.naziUpdate(t)},this.naziUpdate=function(t){!0===AntifaControl.killedFirstFolk?(1<(r+=t/.25)&&(r=1),.2<=(o+=t)&&(o=0,n=!n,AntifaControl.naziCount>l&&(a=l,h=AntifaControl.naziCount,r=0)),l=scintilla.Math.lerp(a,h,r)):0===d?Environment.largeTribeArea.intersects(i.x,i.y,8,8)&&(d=1,i.reachTheTribe=!0):1<=d&&!0===AntifaControl.peace&&(1==d?Environment.tribeArea.intersects(i.x,i.y,8,8)&&(d=2):30<=(s+=t)&&(Environment.endGame=1))},this.naziUI=function(t){if(0<l)for(var i=0,e=0;e<4*l;e++)i=n-e%2==0?0:1,t.spritePart("chars",2+10*e,5-i,128,176+8*i,8,8)},this.gui=function(t){t.color="#000",t.rect(0,0,320,16),this.naziUI(t)}}function Player(){var o;this.state=0,this.tile={x:0,y:0},this.toTile={x:0,y:0};var n=!(this.oldTile={x:0,y:0}),l=!1,a=0,h=0,r=0,d={x:9,y:7},c={x:0,y:0};this.dir=3,this.reachTheTribe=!1,this.start=function(){(o=this.modules.attach.animMachine("bugreiro")).onAnimationEnd=this.animationEnd,this.modules.get("render").depth=5,this.origin.set(.5,.5),this.tile.x=10,this.tile.y=7,SetToTile(this,this.tile.x,this.tile.y),o.stop()},this.ChangeState=function(t,i){void 0===i&&(i=this.dir);var e="bug_",s="";switch(this.dir=i){case 0:case 1:s="side";break;case 2:s="up";break;case 3:s="down"}2===t&&(e+="shoot_"),e+=s,o.setState(e),this.state!==t&&(this.state=t),!1===o.isPlaying&&o.play()},this.ActiveMoving=function(t){this.scale.x=t,n=!0,a=0,d.x=this.x,d.y=this.y},this.animationEnd=function(){l&&(l=!1,this.waitToChangeState=250)},this.scheduleShoot=!1,this.timeToCreateBullet=0,this.bulletCreated=!1,this.waitToChangeState=0,this.Shoot=function(){this.ChangeState(2),l=!0,this.timeToCreateBullet=0,this.bulletCreated=!1;var t=this.scene.pool.pull("bullet_efx");this.scene.audio.playOnce("shoot"),t.setup(this.position,this.dir)},this.update=function(t){if(!1===l&&0===Environment.endGame){var i=this.scene.key.pressed(scintilla.KeyCode.Space),e=-this.scene.key.press(scintilla.KeyCode.Left)+this.scene.key.press(scintilla.KeyCode.Right),s=-this.scene.key.press(scintilla.KeyCode.Up)+this.scene.key.press(scintilla.KeyCode.Down);i&&(n?this.scheduleShoot=!0:this.Shoot()),!1===n&&!1===l&&(0!==e?(h=e,r=0,this.ChangeState(1,-1===e?0:1),this.ActiveMoving(-e)):0!==s?(r=s,h=0,this.ChangeState(1,-1==s?2:3),this.ActiveMoving(1)):(o.stop(),n=!1),n?(c.x=Math.round(this.x+16*h),c.y=Math.round(this.y+16*r),this.oldTile.x=this.tile.x,this.oldTile.y=this.tile.y,WorldToTile(c.x-8,c.y-8,this.toTile),(CheckMapCollision(this.toTile.x,this.toTile.y)||CollidesWithFolk(this.toTile.x,this.toTile.y,!0))&&(o.stop(),n=!1,this.toTile.x=-99,this.toTile.y=-99)):!1===l&&0<this.waitToChangeState&&(this.waitToChangeState-=1e3*t,this.waitToChangeState<=0&&(this.ChangeState(1),this.waitToChangeState=0)))}(n&&(1<=(a+=t/.32)&&(n=!1,(a=1)==this.scheduleShoot&&(this.Shoot(),this.scheduleShoot=!1)),0!==h&&(this.x=scintilla.Math.lerp(d.x,c.x,a)),0!==r&&(this.y=scintilla.Math.lerp(d.y,c.y,a)),WorldToTile(this.x-8,this.y-8,this.tile),n||(this.x=c.x,this.y=c.y,RoundToTile(this),WorldToTile(this.x-8,this.y-8,this.tile),this.oldTile.x=this.tile.x,this.oldTile.y=this.tile.y)),!0===l&&!1===this.bulletCreated&&0===Environment.endGame)&&(this.timeToCreateBullet+=1e3*t,120<=this.timeToCreateBullet&&(this.scene.pool.pull("bullet").setup(this.position,this.dir),this.bulletCreated=!0))}}var VIEW={w:640,h:480},config={width:VIEW.w,height:VIEW.h,camera:{width:320,height:240},parent:"canvas-container",debug:!1,fps:60,pixelated:!0,roundPixels:!1,floorTiles:!0},game=new scintilla.Game(config);game.render.layer.add("game"),game.scene.add("logo",SceneLogo),game.scene.add("title",SceneTitle),game.scene.add("game",SceneGame),game.scene.set("logo");