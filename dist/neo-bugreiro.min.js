/*! neo-bugreiro 26-04-2018 */

var MAX_FOLKS=8,MAP_MAX=1920,LONG_MAP_MAX=3200,SYMBOL_START_ANGLE=Math.PI-Math.PI/2,SYMBOL_RADIUS=84,MAX_BULLETS=3,SHOOT_PERIOD=160,SHOOT_TIMER=120,TRACE_LENGTH=11,FPLAYER_TILE_START=32,FPLAYER_TILE_END=173,FPLAYER_TILE_MAX=FPLAYER_TILE_END-FPLAYER_TILE_START,BULLET_SPD=100,AVOIDANCE_LEVEL=40,FOLK_MAX_PATH_FINDING_STEPS=15,DURATION_BETWEEN_AI=.24,DURATION_BETWEEN_PEACE_WALK=.8,AntifaController=function(){this.deadFolkPlaces=[],this.fascistMode=!1,this.naziCount=0,this.antifaCount=0,this.activeSymbolBar=!1,this.peace=!0,this.reset=function(){this.deadFolkPlaces.length=0,this.naziChoices=0,this.naziCount=0,this.antifaCount=0,this.activeSymbolBar=!1,this.peace=!0}},GameEnvironment=function(){this.map=null,this.mapColliderLayer=null,this.mapColliderUpperLayer=null,this.folks=[],this.bullets=[],this.player=null,this.ai=null,this.endGame=-1,this.tribeArea=null,this.largeTribeArea=null,this.safePoints=null,this.blockingPaths=null,this.reachCity=!1,this.removeFolk=function(t){var i=this.folks.indexOf(t);this.folks.splice(i,1)},this.reset=function(){this.map=null,this.mapColliderLayer=null,this.mapColliderUpperLayer=null,this.player=null,this.endGame=-1,this.bullets.length=0,this.folks.length=0,this.reachCity=!1,this.tribeArea=null,this.largeTribeArea=null,this.ai=null,this.blockingPaths=null},this.playerReachedToCity=function(){if(this.reachCity=!0,0!==this.bullets.length){for(var t=0;t<this.bullets.length;t++)this.bullets[t].Explode(void 0,!1);this.bullets.length=0}}},dollarSymbolFrame={x:128,y:64},quadSymbolFrame={x:112,y:32},flagSymbolFrame={x:96,y:48},bloodFrame={x:48,y:0,width:16,height:16},folkLimit={xMin:26,xMax:35},Environment=new GameEnvironment,AntifaControl=new AntifaController,Heuristic={ISQRT:Math.SQRT2-1,manhattan:function(t,i,e,n){return 10*(Math.abs(e-t)+Math.abs(n-i))},euclidean:function(t,i){var e=i.x-t.x,n=i.y-t.y;return Math.sqrt(e*e+n*n)},octagonal:function(t,i){return t<i?this.ISQRT*t+i:this.ISQRT*i+t},chebyshev:function(t,i){var e=Math.abs(i.x-t.x),n=Math.abs(i.y-t.y);return Math.max(e,n)}},PathMovementCost=[14,10,14,10,0,10,14,10,14],PathDirections=[{x:1,y:0},{x:-1,y:0},{x:0,y:1},{x:0,y:-1},{x:-1,y:-1},{x:1,y:1},{x:-1,y:1},{x:1,y:-1}],PathNode=function(t,i,e){this.score=function(){return this.G+this.H},this.update=function(t){void 0===t&&(t=this.G),this.G=t,this.F=this.G+this.H},this.setParent=function(t){return null!=t&&(this.depth=t.depth+1),this.parent=t,this.depth},this.x=t||0,this.y=i||0,this.depth=0,this.parent=e||null,this.setParent(this.parent),this.G=0,this.H=0,this.F=0},PathFinding=function(t,i,e,n){var u=new scintilla.Structure.Set,m=new scintilla.Structure.Set,s=new scintilla.Structure.List(void 0,!1);void 0===e&&(pooSize=300);for(var o=0;o<e;o++)s.push(new PathNode(null,null,null));this.map=i,this.movementDirections=4,this.collisionPredicate=n||null,this.PullNodePooling=function(t,i,e){var n;return(n=0<s.length?s.pop():new PathNode).x=t,n.y=i,n.setParent(e),n.depth=0,n},this.ResetNodes=function(){u.each(function(t){t.parent=null,t.depth=0,s.push(t)}),m.each(function(t){t.parent=null,t.depth=0,s.push(t)}),m.clear(),u.clear()},BuildPath=function(t){for(var i=[];null!==t;)i.push({x:t.x,y:t.y}),t=t.parent;return i.reverse(),i},FindNode=function(t,i,e){for(var n=t.content(),s=n.length,o=0;o<s;o++)if(n[o].x===i&&n[o].y===e)return n[o];return null},RemoveNode=function(t,i,e){for(var n=t.content(),s=n.length,o=0;o<s;o++)if(n[o].x===i&&n[o].y===e)return void n.splice(o,1)},FindBestNode=function(t){var i=t.content(),e=i.length;if(0===e)return null;for(var n=i[0],s=1;s<e;s++)i[s].F<=n.F&&(n=i[s]);return n},this.FindPath=function(t,i,e,n,s){if(void 0===n&&(n=this.collisionPredicate),null==n)return console.warn("Error: Could not find path."),null;var o,l,a,h,r;this.ResetNodes(),void 0!==e&&e<0&&(e=void 0);var d=null,c=0;for(m.insert(this.PullNodePooling(t.x,t.y,null));0!==m.length;){if(null===(d=FindBestNode(m)))return null;if(d.x===i.x&&d.y===i.y)return BuildPath(d);if(void 0!==e&&e<=c)return BuildPath(d);for(m.erase(d),u.insert(d),l=0;l<this.movementDirections;l++)a=d.x+PathDirections[l].x,h=d.y+PathDirections[l].y,o=d.G+(l<4?10:14),a<0||a>=this.map.width||h<0||h>=this.map.height||null===FindNode(u,a,h)&&(n(a,h,s)||((r=FindNode(m,a,h))?o<r.G&&(r.parent=d,r.update(o)):((r=this.PullNodePooling(a,h,d)).G=o,r.H=Heuristic.manhattan(a,h,i.x,i.y),r.update(o),m.insert(r),c=Math.max(c,r.depth))))}return null}},PathFinder=new PathFinding(4);function SetToTile(t,i,e){t.position.set(scintilla.Math.round(16*i)+16*t.origin.x,scintilla.Math.round(16*e)+16*t.origin.y)}function SetToRoundedTile(t,i,e){void 0!==t.tile&&(t.tile.x=i,t.tile.y=e),t.position.set(16*i+8,16*e+8)}function GetEntityTile(t){return{x:Math.round((t.x+16*t.origin.x)/16),y:Math.round((t.y+16*t.origin.y)/16)}}function GetTile(t,i){return{x:Math.round(t/16),y:Math.round(i/16)}}function GetFlooredTile(t,i){return{x:Math.floor(t/16),y:Math.floor(i/16)}}function WorldToTile(t,i,e){e.x=Math.round(t/16),e.y=Math.round(i/16)}function WorldToFlooredTile(t,i,e){e.x=Math.floor(t/16),e.y=Math.floor(i/16)}function RoundToTile(t){var i=Math.round((t.x-8)/16),e=Math.round((t.y-8)/16);t.position.set(16*i+8,16*e+8),void 0!==t.tile&&(t.tile.x=i,t.tile.y=e)}function CreateTiledEntity(t,i){t.spd=i||25,t.spdDuration=16/i,t.moveTimer=0,t.isMoving=!1,t.hspd=0,t.vspd=0,t.dir=0,t.oldPos={x:0,y:0},t.destPos={x:0,y:0},t.oldTile={x:0,y:0},t.toTile={x:0,y:0},t.tile=GetTile(t.x-8,t.y-8),t.beingSmart=!1}function ActiveTileMovement(t,i,e){t.isMoving=!0,t.moveTimer=0,t.oldPos.x=t.x,t.oldPos.y=t.y,t.oldTile.x=t.tile.x,t.oldTile.y=t.tile.y,t.toTile.x=t.oldTile.x+i,t.toTile.y=t.oldTile.y+e,t.beingSmart=!1}function TileMovement(t,i,e){t.moveTimer+=i/e,1<=t.moveTimer&&(t.isMoving=!1,t.moveTimer=1),0!==t.hspd&&(t.x=scintilla.Math.lerp(t.oldPos.x,t.destPos.x,t.moveTimer)),0!==t.vspd&&(t.y=scintilla.Math.lerp(t.oldPos.y,t.destPos.y,t.moveTimer)),WorldToFlooredTile(t.x,t.y,t.tile),.5<=t.moveTimer&&(t.oldTile.x=t.tile.x,t.oldTile.y=t.tile.y),t.isMoving||(t.x=t.destPos.x,t.y=t.destPos.y,RoundToTile(t),t.oldTile.x=t.tile.x,t.oldTile.y=t.tile.y)}function ActivePathNodeMovement(t,i){var e=0;return t.oldTile.x=t.tile.x,t.oldTile.y=t.tile.y,t.toTile.x=i.x,t.toTile.y=i.x,t.oldPos.x=t.x,t.oldPos.y=t.y,t.hspd=i.x-t.tile.x,t.vspd=i.y-t.tile.y,0!==t.hspd?(t.vspd=0,e=-1===t.hspd?1:0):0!==t.vspd&&(t.hspd=0,e=1===t.vspd?3:2),t.destPos.x=Math.round(16*i.x+8),t.destPos.y=Math.round(16*i.y+8),t.isMoving=!0,t.beingSmart=!0,t.moveTimer=0,e}function FolkTileMovementThroughPathNode(t,i,e,n){if(i.moveTimer+=e/n,1<=i.moveTimer&&(i.moveTimer=1,i.isMoving=!1),0!==i.hspd&&(i.x=scintilla.Math.lerp(i.oldPos.x,i.destPos.x,i.moveTimer)),0!==i.vspd&&(i.y=scintilla.Math.lerp(i.oldPos.y,i.destPos.y,i.moveTimer)),WorldToFlooredTile(i.x-8,i.y-8,i.tile),.5<=i.moveTimer&&(i.oldTile.x=i.tile.x,i.oldTile.y=i.tile.y),!1===i.isMoving){i.x=i.destPos.x,i.y=i.destPos.y,RoundToTile(i),i.navigation++;var s=t.length;if(i.navigation<s){var o=t[i.navigation];i.tile.x=t[i.navigation-1].x,i.tile.y=t[i.navigation-1].y,i.navigation,FolkPathFindCollisionTest(o.x,o.y,this)?(t=null,i.navigation=0):ChangeFolkState(i,ActivePathNodeMovement(i,o))}else t=null,i.navigation=0}}function TileTrace(t,i,e,n){for(var s=0,o=t.x,l=t.y;s<n&&!1!==CheckMapCollision(o,l);s++)o+=i,l+=e;return{x:o,y:l}}function TraceToTarget(t,i,e,n,s){for(var o=0,l=t.x,a=t.y;o<s;o++){if(CheckMapCollision(l+=e,a+=n))return!1;if(l===i.tile.x&&a===i.tile.y)return!0;if(l===i.toTile.x&&a===i.toTile.y)return!0}return!1}function TileMovementThroughPathNode(t,i,e){if(i.moveTimer+=e/i.spdDuration,1<=i.moveTimer&&(i.moveTimer=1,i.isMoving=!1),0!==i.hspd&&(i.x=scintilla.Math.lerp(i.oldPos.x,i.destPos.x,i.moveTimer)),0!==i.vspd&&(i.y=scintilla.Math.lerp(i.oldPos.y,i.destPos.y,i.moveTimer)),WorldToFlooredTile(i.x-8,i.y-8,i.tile),.5<=i.moveTimer&&(i.oldTile.x=i.tile.x,i.oldTile.y=i.tile.y),!1===i.isMoving){i.x=i.destPos.x,i.y=i.destPos.y,RoundToTile(i),i.navigation++;var n=t.length;if(i.navigation<n){var s=t[i.navigation];i.tile.x=t[i.navigation-1].x,i.tile.y=t[i.navigation-1].y;var o=ActivePathNodeMovement(i,s);return void i.ChangeState(o)}t=null}}function TileIsColliadable(t){return null!==t&&(void 0!==t&&!0===t.data.properties.colliadable)}function CheckMapCollision(t,i){if(i<0||t<0)return!0;if(t>=Environment.map.width||i>=Environment.map.height)return!0;var e=Environment.mapColliderLayer.getTile(t,i);return!1!==TileIsColliadable(e)||TileIsColliadable(e=Environment.mapColliderUpperLayer.getTile(t,i))}function CheckExtrapolatedMapCollision(t,i){if(t<0)return!1;if(i<0)return!0;if(t>=Environment.map.width||i>=Environment.map.height)return!0;var e=Environment.mapColliderLayer.getTile(t,i);return!1!==TileIsColliadable(e)||TileIsColliadable(e=Environment.mapColliderUpperLayer.getTile(t,i))}function CollidesWithFolk(t,i,e,n){var s;void 0===e&&(e=!0);for(var o=0;o<Environment.folks.length;o++)if(s=Environment.folks[o],(void 0===n||n!==o)&&!0!==s.dead){if(s.tile.x===t&&s.tile.y===i)return s;if(!0===e&&!0===s.isMoving&&s.toTile.x===t&&s.toTile.y===i)return s}return null}function CheckFolkCollision(t,i,e){for(var n,s=0;s<Environment.folks.length;s++)if(!0!==(n=Environment.folks[s]).dead&&(void 0===e||n.id!==e)){if(n.tile.x===t&&n.tile.y===i)return n;if(!0===n.isMoving&&n.toTile.x===t&&n.toTile.y===i)return n}return null}function CheckDirectionalCollision(t,i,e){e[0]=!CheckMapCollision(t.x+1,t.y)&&!CheckFolkCollision(t.x+1,t.y,i)&&!CollideWithPlayer(t.x+1,t.y),e[1]=!CheckMapCollision(t.x-1,t.y)&&!CheckFolkCollision(t.x-1,t.y,i)&&!CollideWithPlayer(t.x-1,t.y),e[2]=!CheckMapCollision(t.x,t.y-1)&&!CheckFolkCollision(t.x,t.y-1,i)&&!CollideWithPlayer(t.x,t.y-1),e[3]=!CheckMapCollision(t.x,t.y+1)&&!CheckFolkCollision(t.x,t.y+1,i)&&!CollideWithPlayer(t.x,t.y+1),e[4]=!(e[0]||e[1]||e[2]||e[3])}function CollideWithPlayer(t,i){return Environment.player.tile.x===t&&Environment.player.tile.y===i||(Environment.player.oldTile.x===t&&Environment.player.oldTile.y===i||!(!Environment.player.isMoving||Environment.player.toTile.x!==t||Environment.player.toTile.y!==i))}function CollideWith(t,i,e){return t.tile.x===i&&t.tile.y===e||!(!t.isMoving||t.toTile.x!==i||t.toTile.y!==e)}function FullCollideWith(t,i){return t.tile.x==i.tile.x&&t.tile.y==i.tile.y||(t.toTile.x==i.toTile.x&&t.toTile.y==i.toTile.y||(t.toTile.x==i.tile.x&&t.toTile.y==i.tile.y||i.toTile.x==t.tile.x&&i.toTile.y==t.tile.y))}function AvoidBugreiro(t,i){return!0===AntifaControl.fascistMode?scintilla.Math.inManhattanRadius(Environment.player.tile.x,Environment.player.tile.y,t,i,3)||CollideWithPlayer(t,i):scintilla.Math.inManhattanRadius(Environment.ai.tile.x,Environment.ai.tile.y,t,i,3)||CollideWith(Environment.ai,t,i)||CollideWithPlayer(t,i)}function FolkPathFindCollisionTest(t,i,e){return t<=folkLimit.xMin||(!1===AntifaControl.fascistMode&&t>=folkLimit.xMax||(void 0!==e&&(n=e.id),CheckMapCollision(t,i)||CheckFolkCollision(t,i,n)||AvoidBugreiro(t,i)));var n}function CollideWithBlockedPath(t,i,e){for(var n=0,s=16*t,o=16*i;n<Environment.blockingPaths.length&&n!==e;n++)if(Environment.blockingPaths.at(n).intersects(s,o,16,16))return!0;return!1}function CameraFollowBugreiro(t,i){var e=i.x-144;e<=0?e=0:MAP_MAX-176-144<=e&&(e=MAP_MAX-176-144),t.x=e}function OnBugreiroAnimationEnd(){(this.isShooting||this.isAttacking)&&(this.isShooting=!1,this.isAttacking=!1,this.waitToChangeState=SHOOT_PERIOD),0!==Environment.endGame&&(ChangeBugreiroState(this,0),this.animMachine.stop())}function ChangeBugreiroState(t,i,e){void 0===e&&(e=t.dir);var n="bug_",s="",o=1;switch(e){case 0:case 1:s="side";break;case 2:s="up";break;case 3:s="down"}0===(t.dir=e)&&(o=-1),t.scale.x=o,2===i?n+="shoot_":3===i&&(n+="blade_"),n+=s,t.animMachine.setState(n),t.state!==i&&(t.state=i),!1===t.animMachine.isPlaying&&t.animMachine.play()}function ActiveBugreiroMoving(t){t.isMoving=!0,t.moveTimer=0,t.oldPos.x=t.x,t.oldPos.y=t.y}function BugreiroShoot(t,i){t.isMoving=!1,t.moveTimer=0,ChangeBugreiroState(t,2,i),t.isShooting=!0,t.timeToCreateBullet=0,t.bulletCreated=!1;var e=t.scene.pool.pull("bullet_efx");0===Environment.endGame&&t.scene.audio.playOnce("shoot"),e.setup(t.position,t.dir)}function BugreiroAttack(t,i,e){t.isMoving=!1,t.moveTimer=0,ChangeBugreiroState(t,3,e),t.isAttacking=!0,KillFolk(i,t.scene)}function IsNearAndOnDirectionToFolk(t,i,e,n){var s,o,l,a,h=GetNearestFolkByTile(t,i);if(null===h)return null;switch(s=t-h.tile.x,o=i-h.tile.y,l=Math.abs(t-h.oldTile.x),a=Math.abs(i-h.oldTile.y),e){case 0:if((1===s||1===l||t===h.tile.x)&&0===o)return h;break;case 1:if((-1===s||1===l||t===h.tile.x)&&0===o)return h;break;case 2:if((1===o||1===a||i===h.tile.y)&&0===s)return h;break;case 3:if((-1===o||1===a||i===h.tile.y)&&0===s)return h}return null}function BugreiroAICollisionTest(t,i,e){return CheckMapCollision(t,i)}function BugreiroTileMovementThroughPathNode(t,i,e,n){if(i.moveTimer+=e/n,1<=i.moveTimer&&(i.moveTimer=1,i.isMoving=!1),0!==i.hspd&&(i.x=scintilla.Math.lerp(i.oldPos.x,i.destPos.x,i.moveTimer)),0!==i.vspd&&(i.y=scintilla.Math.lerp(i.oldPos.y,i.destPos.y,i.moveTimer)),WorldToTile(i.x-8,i.y-8,i.tile),.5<=i.moveTimer&&(i.oldTile.x=i.tile.x,i.oldTile.y=i.tile.y),!1===i.isMoving){i.x=i.destPos.x,i.y=i.destPos.y,RoundToTile(i),i.navigation++,WorldToTile(i.x-8,i.y-8,i.tile);var s=null;if(!1===Environment.reachCity&&null===(s=BugreiroCanShoot(i,i.target))){var o=GetNearestFolkByTile(i.tile.x,i.tile.y);null!==o&&(s=BugreiroCanShoot(i,o))}if(null!==s)return void BugreiroAIScheduleAttack(i,s);var l=t.length,a=!0;if(null!==i.target&&(a=scintilla.Math.inManhattanRadius(i.targetTile.x,i.targetTile.y,i.target.tile.x,i.target.tile.y,4)),a&&i.navigation<l){var h=t[i.navigation],r=BugreiroAICollisionTest(h.x,h.y);if(null!==i.target&&(r=r||!0===i.target.dead),!r)if(!1===Environment.reachCity)return void ChangeBugreiroState(i,1,ActivePathNodeMovement(i,h))}t=null,i.navigation=0}}function InAxis(t,i){return t.tile.x===i.tile.x?1:t.tile.y===i.tile.y?2:t.tile.x===i.toTile.x?1:t.tile.y===i.toTile.y?2:0}function IsNear(t,i){if(null===i)return!1;var e,n;if(e=t.tile.x-i.tile.x,0===(n=t.tile.y-i.tile.y)){if(1===e)return 1;if(-1===e)return 0}else if(0===e){if(1===n)return 2;if(-1===n)return 3}return null}function BugreiroCanShoot(t,i){if(null===i)return null;if(i.dead)return null;var e=InAxis(t,i);if(0!==e){var n=IsNear(t,i);if(null!==n)return{shoot:!1,axis:e,dir:n,target:i};var s=0,o=0;if(2===e&&(t.tile.x>i.tile.x?s=-1:t.tile.x<i.tile.x&&(s=1)),0===s&&(t.tile.y>i.tile.y?o=-1:t.tile.y<i.tile.y&&(o=1)),scintilla.Math.inManhattanRadius(t.tile.x,t.tile.y,i.tile.x,i.tile.y,TRACE_LENGTH)&&TraceToTarget(t.tile,i,s,o,TRACE_LENGTH))return{shoot:!0,axis:e,v:o,h:s,target:i}}return null}function BugreiroAIScheduleAttack(t,i){var e;i.shoot?Environment.bullets.length<MAX_BULLETS?(t.chainNode=null,(t.navigation=0)!==i.v&&(e=-1===i.v?2:3),0!==i.h&&(e=1===i.h?0:1),BugreiroShoot(t,e)):(t.isMoving=!1,t.moveTimer=0,t.animMachine.stop()):!1===i.target.dead?BugreiroAttack(t,i.target,i.dir):(t.isMoving=!1,t.moveTimer=0,t.animMachine.stop())}function Bugreiro(){this.state=0,this.tile={x:0,y:0},this.toTile={x:0,y:0},this.oldTile={x:0,y:0},this.isMoving=!1,this.isShooting=!1,this.isAttacking=!1;var l=this.moveTimer=0,a=0;this.oldPos={x:9,y:7},this.destPos={x:0,y:0},this.dir=3,this.reachTheTribe=!1,this.animMachine=null,this.scheduleShoot=!1,this.timeToCreateBullet=0,this.bulletCreated=!1,this.waitToChangeState=0,this.start=function(){this.animMachine=this.modules.attach.animMachine("bugreiro"),this.animMachine.onAnimationEnd=OnBugreiroAnimationEnd,this.modules.get("render").depth=5,this.origin.set(.5,.5),this.tile.x=9,this.tile.y=7,SetToTile(this,this.tile.x,this.tile.y),this.animMachine.stop()},this.update=function(t){if(0===Environment.endGame&&!1===this.isAttacking&&!1===this.isShooting){var i=this.scene.key.pressed(scintilla.KeyCode.Space),e=-this.scene.key.press(scintilla.KeyCode.Left)+this.scene.key.press(scintilla.KeyCode.Right),n=-this.scene.key.press(scintilla.KeyCode.Up)+this.scene.key.press(scintilla.KeyCode.Down);if(i){var s=IsNearAndOnDirectionToFolk(this.tile.x,this.tile.y,this.dir,1);s?BugreiroAttack(this,s):Environment.bullets.length<MAX_BULLETS&&(this.isMoving?this.scheduleShoot=!0:BugreiroShoot(this))}!1===this.isMoving&&!1===this.isShooting&&!1===this.isAttacking&&(0!==e?(a=0,ChangeBugreiroState(this,1,1===(l=e)?0:1),ActiveBugreiroMoving(this)):0!==n?(l=0,ChangeBugreiroState(this,1,-1===(a=n)?2:3),ActiveBugreiroMoving(this)):(this.animMachine.stop(),this.isMoving=!1),this.isMoving?(this.destPos.x=Math.round(this.x+16*l),this.destPos.y=Math.round(this.y+16*a),this.oldTile.x=this.tile.x,this.oldTile.y=this.tile.y,WorldToTile(this.destPos.x-8,this.destPos.y-8,this.toTile),(CheckExtrapolatedMapCollision(this.toTile.x,this.toTile.y)||CollidesWithFolk(this.toTile.x,this.toTile.y,!0))&&(this.animMachine.stop(),this.isMoving=!1,this.toTile.x=-99,this.toTile.y=-99)):!1===this.isShooting&&0<this.waitToChangeState&&(this.waitToChangeState-=1e3*t,this.waitToChangeState<=0&&(ChangeBugreiroState(this,1),this.waitToChangeState=0)))}if(this.isMoving&&(this.moveTimer+=t/.32,1<=this.moveTimer&&(this.isMoving=!1,(this.moveTimer=1)==this.scheduleShoot&&(BugreiroShoot(this),this.scheduleShoot=!1)),0!==l&&(this.x=scintilla.Math.lerp(this.oldPos.x,this.destPos.x,this.moveTimer)),0!==a&&(this.y=scintilla.Math.lerp(this.oldPos.y,this.destPos.y,this.moveTimer)),WorldToTile(this.x-8,this.y-8,this.tile),this.isMoving||(this.x=this.destPos.x,this.y=this.destPos.y,RoundToTile(this),WorldToTile(this.x-8,this.y-8,this.tile),this.oldTile.x=this.tile.x,this.oldTile.y=this.tile.y)),!0===this.isShooting&&!1===this.bulletCreated&&0===Environment.endGame&&(this.timeToCreateBullet+=1e3*t,this.timeToCreateBullet>=SHOOT_TIMER&&Environment.bullets.length<MAX_BULLETS)){var o=this.scene.pool.pull("bullet");o.setup(this.position,this.dir),this.bulletCreated=!0,Environment.bullets.push(o)}}}function BugreiroAI(){this.spr=null,this.isMoving=!1,this.isShooting=!1,this.isAttacking=!1,this.scheduleShoot=!1,this.timeToCreateBullet=0,this.bulletCreated=!1,this.animMachine=null,this.pursuingPlayer=!1,this.chainNode=null,this.target=null,this.targetTile={x:0,y:0},this.speedUp=!1,this.navigation=0,this.start=function(){CreateTiledEntity(this,50),this.animMachine=this.modules.attach.animMachine("bugreiro"),this.animMachine.onAnimationEnd=OnBugreiroAnimationEnd,this.origin.set(.5,.5),this.spr=this.modules.get("render"),this.spr.depth=4,this.animMachine.stop(),this.tile.x=0,this.tile.y=5,SetToTile(this,this.tile.x,this.tile.y)},this.speedUpBug=function(){!1===this.speedUp&&(this.spd=58.5,this.spdDuration=16/this.spd,this.speedUp=!0)},this.pursuitPlayer=function(){if(!this.scene.camera.isCulled(this.spr)&&Environment.player.tile.x>=FPLAYER_TILE_START){var t=GetFlooredTile(this.scene.camera.x,this.scene.camera.y);t.x-=2;var i=TileTrace(t,0,1,20);SetToRoundedTile(this,i.x,i.y),this.speedUpBug()}KillAllFolks(),this.pursuingPlayer=!0,this.isMoving=!1,this.isAttacking=!1,this.isShooting=!1,this.bulletCreated=!1,this.bulletCreated=!1},this.update=function(t){if(!1===this.isAttacking&&!1===this.isShooting&&!1===this.isMoving){if(!1===Environment.reachCity){if(!1===this.pursuingPlayer?this.target=GetNearestFolkByTile(this.tile.x,this.tile.y):(this.target=null,!1===this.speedUp&&32<this.tile.x&&this.speedUpBug()),null===this.target)!1===Environment.player.dead&&(!1===this.pursuingPlayer&&this.pursuitPlayer(),this.target=Environment.player);else if(43<Environment.player.tile.x)!1===Environment.player.dead&&(!1===this.pursuingPlayer&&this.pursuitPlayer(),this.target=Environment.player);else if(!1===Environment.player.dead){var i=scintilla.Math.manhattan(this.tile.x,this.tile.y,Environment.player.tile.x,Environment.player.tile.y),e=scintilla.Math.manhattan(this.tile.x,this.tile.y,this.target.tile.x,this.target.tile.y);i.x<e.x&&i.y<e.y&&(this.target=Environment.player)}}else this.target=null;var n=null;if(null!==this.target?(this.targetTile.x=this.target.tile.x,this.targetTile.y=this.target.tile.y,!1===Environment.reachCity&&(n=BugreiroCanShoot(this,this.target))):(this.targetTile.x=2,this.targetTile.y=5),null===n){if(this.chainNode=PathFinder.FindPath(this.tile,this.targetTile,void 0,BugreiroAICollisionTest,this),null!==this.chainNode)if(1<this.chainNode.length)this.navigation=1,ChangeBugreiroState(this,1,ActivePathNodeMovement(this,this.chainNode[1]))}else BugreiroAIScheduleAttack(this,n)}if(!0===this.isMoving&&BugreiroTileMovementThroughPathNode(this.chainNode,this,t,this.spdDuration),!1===Environment.reachCity&&!0===this.isShooting&&!1===this.bulletCreated&&(this.timeToCreateBullet+=1e3*t,this.timeToCreateBullet>=SHOOT_TIMER))if(this.bulletCreated=!0,Environment.bullets.length<MAX_BULLETS){var s=this.scene.pool.pull("bullet");s.setup(this.position,this.dir),Environment.bullets.push(s)}else this.isShooting=!1}}function ChangeFolkState(t,i){void 0===i&&(i=t.dir);var e="",n=1;switch(i){case 0:e="side",n=-1;break;case 1:e="side";break;case 2:e="up";break;case 3:e="down"}t.scale.x=n,t.dir=i,t.animMachine.setState("folk_"+e+"_"+t.id.toString()),!1===t.animMachine.isPlaying&&t.animMachine.play()}function PreventFolkToGoToEnemy(t,i){var e=Environment.player;!1===Environment.fascistMode&&(e=Environment.ai);var n=Math.abs(t.tile.x-e.tile.x),s=Math.abs(t.tile.y-e.tile.y),o=scintilla.Random.irange(0,100);if(0===i){if(n<3){if(t.tile.x-e.tile.x<0)return!1}else if(0!==n&&o<AVOIDANCE_LEVEL)return!1}else if(1===i){if(n<13){if(e.tile.x-t.tile.x<0)return!1}else if(0!==n&&o<AVOIDANCE_LEVEL)return!1}else if(2===i){if(s<2){if(e.tile.y-t.tile.y<0)return!1;if(0!==s&&o<AVOIDANCE_LEVEL)return!1}}else if(3===i)if(s<2){if(t.tile.y-e.tile.y<0)return!1}else if(0!==s&&o<AVOIDANCE_LEVEL)return!1;return!0}function RandomizeFolkDirection(t){var i,e=[],n=0,s=null;for(n=0;n<4;n++)if(!0===t.tileDirection[n]){if(1===n){if(t.tile.x<=folkLimit.xMin)continue}else if(0===n&&!1===AntifaControl.fascistMode&&t.tile.x>=folkLimit.xMax)continue;!0===PreventFolkToGoToEnemy(t,n)?e.push(n):s=n}var o=0;return 0<(i=e.length)||null!==s?(0<i?o=e[o=scintilla.Random.irange(0,i)]:null!==s&&(o=s),o<=1?(t.hspd=1===o?-1:1,t.vspd=0):(t.vspd=3===o?1:-1,t.hspd=0)):(t.vspd=0,t.hspd=0),o}function PeacefulRandomizeFolkDirection(t){for(var i,e=[],n=0,s=0;n<4;n++)if(!0===t.tileDirection[n]){if(1===n){if(t.tile.x<=folkLimit.xMin)continue}else if(0===n&&t.tile.x>=folkLimit.xMax)continue;e.push(n)}return 0<(i=e.length)?(s=e[s=scintilla.Random.irange(0,i)])<=1?(t.hspd=1===s?-1:1,t.vspd=0):(t.vspd=3===s?1:-1,t.hspd=0):(t.vspd=0,t.hspd=0),s}function PeacefulFolk(){!1===this.isMoving&&(WorldToTile(this.x-8,this.y-8,this.tile),this.oldTile.x=this.tile.x,this.oldTile.y=this.tile.y,CheckDirectionalCollision(this.tile,this.id,this.tileDirection),!0===this.tileDirection[4]?timeToWait=DURATION_BETWEEN_AI:(ChangeFolkState(this,PeacefulRandomizeFolkDirection(this)),this.destPos.x=Math.round(this.x+16*this.hspd),this.destPos.y=Math.round(this.y+16*this.vspd),ActiveTileMovement(this,this.vspd,this.hspd)))}function FolkRun(){if(!0!==this.isMoving){WorldToTile(this.x-8,this.y-8,this.tile),this.oldTile.x=this.tile.x,this.oldTile.y=this.tile.y;var t=!0;this.smartness<100&&(t=scintilla.Random.irange(0,100)<=this.smartness);if(104<this.tile.x&&(t=!1),!0===t){this.smartness;var i=GetNearestSafePoint(this.position);t=!1,null!==i&&(i=GetTile(i.x,i.y),this.chainNode=PathFinder.FindPath(this.tile,i,-1,FolkPathFindCollisionTest,this),null!==this.chainNode&&1<this.chainNode.length&&(this.navigation=1,ChangeFolkState(this,ActivePathNodeMovement(this,this.chainNode[1])),t=!0))}!1===t&&(this.beingSmart=!1,CheckDirectionalCollision(this.tile,this.id,this.tileDirection),!0===this.tileDirection[4]?timeToWait=DURATION_BETWEEN_AI:(ChangeFolkState(this,RandomizeFolkDirection(this)),this.destPos.x=Math.round(this.x+16*this.hspd),this.destPos.y=Math.round(this.y+16*this.vspd),ActiveTileMovement(this,this.vspd,this.hspd)))}}function KillFolk(t,i,e){i.entity.create(BloodEffect).folkToDie=t,0===Environment.endGame&&(!0!==e&&void 0!==e||i.audio.playOnce("dead")),t.dead=!0,t.isPlayer||Environment.removeFolk(t),AntifaControl.activeSymbolBar=!0,AntifaControl.peace=!1}function KillAllFolks(){for(var t,i=0;i<Environment.folks.length;i++)!1===(t=Environment.folks[i]).dead&&t.Die();Environment.folks.length=0}function IsFolksCulled(t){for(var i,e=0,n=0;n<Environment.folks.length;n++)!0!==(i=Environment.folks[n]).dead&&t.isCulled(i)&&e++;return 0===e}function GetNearestFolkByTile(t,i){for(var e,n,s=1/0,o=1/0,l=null,a=0;a<Environment.folks.length;a++)!0!==(n=Environment.folks[a]).dead&&(e=scintilla.Math.manhattan(t,i,n.tile.x,n.tile.y)).x<=s&&e.y<=o&&(s=e.x,o=e.y,e=s,l=n);return l}function GetNearestFolk(t,i,e){for(var n,s=null,o=0;o<Environment.folks.length;o++)!0!==(n=Environment.folks[o]).dead&&scintilla.Math.distance(t,i,n.x,n.y)<=1/0&&(1/0,s=n);return s}function GetNearestSafePoint(t){for(var i=null,e=0;e<Environment.safePoints.length;e++)if(point=Environment.safePoints.get(e),point.x>t.x){i=point;break}if(null===i){var n=Environment.safePoints.length-1;i=Environment.safePoints.get(n)}return i}function Folk(){this.animMachine=null,this.spr=null,this.tile=null,this.dead=!1,this.dying=!1,this.id=0,this.tileDirection=[!1,!1,!1,!1,!1];var i=this.smartness=0,n=null,e=!1;this.chainNode=null;var s=.8;this.navigation=0,this.start=function(){CreateTiledEntity(this,25),e=!1,s=.8,(n=this.scene.create.spritesheet("alert")).modules.get("render").depth=12,n.active=!1,this.animMachine=this.modules.attach.animMachine(),this.origin.set(.5,.5),this.spr=this.modules.get("render"),this.spr.depth=2},this.update=function(t){!0!==this.dying&&(!0===AntifaControl.peace?i<=0&&PeacefulFolk.call(this):!1===e?(e=!0,this.animMachine.machine.duration=this.spdDuration/2*1e3,n.active=!0,s=this.spdDuration,i=0):i<=0&&FolkRun.call(this),i<=0?(this.isMoving&&(!1===this.beingSmart?TileMovement(this,t,s):FolkTileMovementThroughPathNode(this.chainNode,this,t,s),!1===this.isMoving&&!1===e&&50<scintilla.Random.irange(0,100)&&(i=DURATION_BETWEEN_PEACE_WALK)),n.x=this.x-8,n.y=this.y-12):i-=t)},this.Setup=function(t,i,e,n){this.player=n,this.position.set(t+8,i+8),this.tile=GetTile(this.x-8,this.y-8),this.oldTile.x=this.tile.x,this.oldTile.y=this.tile.y,this.id=e},this.Die=function(){this.dead=!0,this.dying=!0,this.animMachine.stop(),this.scene.entity.destroy(n);var t=this.id%2*16,i=16*scintilla.Math.floor(this.id/2);this.spr.setFrame(64+t,0+i,16,16);var e=this.scene.create.sprite("effects","blood",bloodFrame);e.position.set(this.x-8,this.y-8),this.spr.depth=1,e.modules.get("render").depth=0,AntifaControl.naziCount++}}function ShootEffect(){var n;this.vspd=0,this.hspd=1,this.start=function(){n=this.modules.attach.spritesheet("shoot_effect_side"),this.modules.get("render").depth=7,n.loop=!1,n.onAnimationEnd=this.end,this.origin.set(.5,.5)},this.end=function(){this.back()},this.setup=function(t,i){var e;switch(i){case 0:case 1:e=1===i?-1:1,n.animation="shoot_effect_side",this.x=t.x+15*e,this.y=t.y,this.scale.x=e;break;case 2:case 3:n.animation="shoot_effect_updown",e=2===i?1:0,this.x=t.x+4*e,this.y=t.y+8*-e,this.scale.x=1}n.restart()}}function BulletExplosion(){this.anim=null,this.start=function(){this.anim=this.modules.attach.spritesheet("bullet_explosion"),this.modules.get("render").depth=8,this.anim.loop=!1,this.anim.onAnimationEnd=this.back,this.origin.set(.5,.5)}}function BloodEffect(){this.folkToDie=null,this.start=function(){var t=this.modules.attach.spritesheet("blood_explosion");this.modules.get("render").depth=9,t.onAnimationEnd=function(){this.scene.entity.destroy(this),this.folkToDie.Die()},t.loop=!1,this.origin.set(.5,.5)},this.update=function(){this.position.set(this.folkToDie.x,this.folkToDie.y)}}function Bullet(){this.vspd=0,this.hspd=1,this.effect=null,this.moduleAnim=null,this.t=0,this.setups=!1;var s,o={x:0,y:0};this.tile={x:0,y:0},this.start=function(){s=this.modules.attach.sprite("effects",80,0,16,16),this.origin.set(.5,.5)},this.Explode=function(t,i){var e=this.scene.pool.pull("explosion");e.anim.restart(),e.position.set(this.x,this.y),void 0===t||t.dead?0===Environment.endGame&&i&&this.scene.audio.playOnce("explosion"):KillFolk(t,this.scene,i),this.removeBullet()},this.removeBullet=function(){var t=Environment.bullets.indexOf(this);-1!==t&&Environment.bullets.splice(t,1),this.setups=!1,this.back()},this.update=function(t){if(!0===this.setups){this.x+=this.hspd*BULLET_SPD*t,this.y+=this.vspd*BULLET_SPD*t;var i=!0,e=this.scene.camera.isCulled(s);if(!0===AntifaControl.fascistMode?(i=e,!0===AntifaControl.peace&&!0===Environment.player.reachTheTribe&&Environment.tribeArea.intersects(this.x-8,this.y-8,16,16)&&(AntifaControl.peace=!1)):!0===AntifaControl.peace&&(AntifaControl.peace=!1),i){WorldToTile(this.x-8,this.y-8-o.y,this.tile);var n=CollidesWithFolk(this.tile.x,this.tile.y,!1);!1===AntifaControl.fascistMode&&null===n&&!1===Environment.player.dead&&(n=CollideWith(Environment.player,this.tile.x,this.tile.y)?Environment.player:null),null===n?CheckMapCollision(this.tile.x,this.tile.y)&&this.Explode(void 0,e):this.Explode(n,e)}else this.removeBullet()}},this.setup=function(t,i){if(!1===this.setups){var e=1;switch(i){case 0:case 1:e=1===i?-1:1,this.vspd=0,this.hspd=e,o.x=0,o.y=1,this.x=t.x+8*e,this.y=t.y+o.y,this.scale.x=e,this.angle=0;break;case 2:case 3:e=3===i?1:-1,this.vspd=e,this.hspd=0,o.y=4*e,this.x=t.x,this.y=t.y+o.y,this.scale.x=1,this.angle=1===e?90:270}s.depth=6,this.setups=!0}}}function SceneLogo(){this.waitLogoTime=0,this.done=!1,this.goToScene="title",this.preload=function(){this.load.setPath("assets/"),this.load.webFont("font","google","Press Start 2P"),this.load.image("titleNeo","img/n_title_neo.png"),this.load.image("titleBugre","img/n_title_bugre.png"),this.load.image("titleBugreBack","img/n_title_bugre_fill.png"),this.load.image("titleBorder","img/n_title_bugre_border.png"),this.load.image("titleChroma","img/n_title_chrome.bmp"),this.load.image("titleBg","img/n_title_bg.bmp"),this.load.image("antifaJamLogo","img/antifagamejamlogo.png"),this.load.audio("titleMusic","sfx/505-loop3.ogg"),this.load.audio("gameMusic","sfx/505-myth.ogg"),this.load.audio("ok","sfx/n_confirm.wav"),this.load.audio("shoot","sfx/n_shot.wav"),this.load.audio("explosion","sfx/n_explosion.wav"),this.load.audio("dead","sfx/n_dead.wav"),this.load.tilemapJSON("tilemap","map/n_tilemap.json"),this.load.tilemapJSON("tilemap_long","map/n_tilemap_long.json"),this.load.image("bugreiro","img/n_bugreiro.png"),this.load.image("npcs","img/n_npcs.png"),this.load.image("effects","img/n_effects.png"),this.load.image("fucku","img/n_fuck_fascist.png"),this.load.image("shaking","img/n_shaking.png"),this.load.image("cocar","img/n_cocar.png"),this.load.image("revolution","img/n_revolution.png"),this.load.image("hat","img/n_hat.png"),this.load.spritesheet("bug_down","bugreiro",[0,0,16,16,2],123),this.load.spritesheet("bug_side","bugreiro",[0,16,16,16,2],123),this.load.spritesheet("bug_up","bugreiro",[0,32,16,16,2],123),this.load.spritesheet("bug_shoot_down","bugreiro",[32,0,16,16,4],120),this.load.spritesheet("bug_shoot_side","bugreiro",[32,16,16,16,4],120),this.load.spritesheet("bug_shoot_up","bugreiro",[32,32,16,16,4],120),this.load.spritesheet("bug_blade_up","bugreiro",[32,48,16,16,4],60),this.load.spritesheet("bug_blade_side","bugreiro",[32,64,16,16,4],60),this.load.spritesheet("bug_blade_down","bugreiro",[32,80,16,16,4],60),this.load.animMachine("bugreiro",["bug_down","bug_side","bug_up","bug_shoot_down","bug_shoot_side","bug_shoot_up","bug_blade_down","bug_blade_side","bug_blade_up"]),this.load.spritesheet("fuck_fascist","fucku",[0,0,55,77,2],200),this.load.spritesheet("hand_shaking","shaking",[0,0,96,77,2],200),this.load.spritesheet("cocar","cocar",[0,0,77,70,2],200),this.load.spritesheet("revolution","revolution",[0,0,53,80,2],200),this.load.spritesheet("hat","hat",[0,0,85,48,2],200),this.load.spritesheet("shoot_effect_side","effects",[0,0,16,16,3,1],120),this.load.spritesheet("shoot_effect_updown","effects",[16,0,16,16,3,1],120),this.load.spritesheet("bullet_explosion","effects",[32,0,16,16,4,1],120),this.load.spritesheet("blood_explosion","effects",[64,0,16,16,5,1],160),this.load.spritesheet("alert","effects",[48,16,16,16,4,1],160),this.load.spritesheet("dol_to_naz_0","effects",[96,64,8,8,4,2]),this.load.spritesheet("dol_to_naz_1","effects",[112,64,8,8,4,2]),this.load.spritesheet("rot_quad","effects",[128,32,8,8,2,1]);for(var t,i,e,n=0,s=0,o=0,l=0;l<MAX_FOLKS;l++)t="folk_down_"+l.toString(),e="folk_side_"+l.toString(),i="folk_up_"+l.toString(),this.load.spritesheet(t,"npcs",[n,s,16,16,2],240),this.load.spritesheet(e,"npcs",[n,s+16,16,16,2],240),this.load.spritesheet(i,"npcs",[n,s+32,16,16,2],240),this.load.animMachine("folk_"+l.toString(),[t,e,i]),2<=++o?(n=o=0,s+=48):n+=32;this.events.subscribe("asset_complete",function(t,i){if(i===scintilla.AssetType.spritesheet){/^bug_shoot_/.test(t.name)?(t.loop=!1,t.duration=120,t.duplicate(0)):/^bug_blade_/.test(t.name)?(t.loop=!1,t.duration=160/1.5,t.duplicate(3),t.duplicate(3),t.duplicate(3)):/^bug_/.test(t.name)&&(t.loop=!0,t.duration=160)}else if(i===scintilla.AssetType.tilemap){if("tilemap_long"===t.name)t.getObjectsLayer("BlockedPaths").sort(function(t,i){return t.x-i.x})}})},this.start=function(){this.transition.settings.setOutDuration(1),this.transition.settings.setEaseOutMethod(scintilla.Ease.Type.CUT,3),this.transition.settings.setEaseInMethod(scintilla.Ease.Type.CUT,3),this.transition.out(),"title"===this.goToScene&&this.audio.playPersistent("titleMusic",.3,!0,"bgm")},this.update=function(t){if(this.done){this.transition.in();this.events.subscribeOnce("transition_end",function(){this.scene.set(this.goToScene)},this)}else this.waitLogoTime+=t/2.5,1<=this.waitLogoTime&&(this.transition.settings.setInDuration(1),this.done=!0)},this.gui=function(t){t.sprite("antifaJamLogo",160,120,.5,.5)}}function SceneTitle(){this.blinkStartTime=0,this.blinkStart=!1;var o=0,l=0,n=0,s=0,a=176.5,h=1,r=!1,d=!1,c=0,u=null,m=!1;this.start=function(){d=r=!1,c=0,u=null,this.blinkStartTime=0,this.blinkStart=!1,this.transition.out(),m=!0,this.events.subscribeOnce("transition_end",function(){m=!1},this),null!==(u=this.audio.get("bgm"))?u.isPlaying||u.play():u=this.audio.playPersistent("titleMusic",.3,!0,"bgm")},this.update=function(t){if(0===c){var i=this.key.pressed(scintilla.KeyCode.Enter)||this.key.pressed(scintilla.KeyCode.Space);if(r)(this.key.pressed(scintilla.KeyCode.Up)||this.key.pressed(scintilla.KeyCode.Down))&&(this.audio.playOnce("ok",.5),d=!d),i&&(this.transition.in(),this.audio.playOnce("ok",.5),this.blinkStartTime=0,AntifaControl.fascistMode=d,this.events.subscribeOnce("transition_end",function(){c=2}),c=1);else this.blinkStartTime+=t,.5<=this.blinkStartTime&&(this.blinkStart=!this.blinkStart,this.blinkStartTime=0),!1===m&&i&&(r=!0,this.audio.playOnce("ok",.5))}else if(2===c){this.blinkStartTime+=t;var e=this.blinkStartTime/1.5;1<=e&&(e=1),u.volume=scintilla.Math.lerp(.3,0,e),2<=this.blinkStartTime&&(this.audio.stopAll(!0),this.scene.set("game"))}1<=(n+=t/6)&&(n=0),s=scintilla.Math.toRadian*(360*n),o=Math.cos(s),l=Math.sin(s)},this.gui=function(t){var i,e;t.defaultComposite(),t.sprite("titleChroma",a,81.5,.5,.5),t.composite="destination-in",t.spriteSkew("titleBugre",a,81.5,.05*o,.05*-l,.5,.5),t.composite="destination-over";for(var n=.05*Math.atan(l),s=.05*Math.atan(o);h<4;h++)i=80*h,e=64*h,t.alpha=scintilla.Math.lerp(1,0,(h-1)/3),t.spriteSkew("titleBugreBack",a+i*s,81.5+e*n,.05*o,.05*-l,.5,.5);if(t.alpha=1,h=1,t.sprite("titleBg",0,0),t.defaultComposite(),t.spriteSkew("titleBorder",a+o,81.5+l,.05*o,.05*-l,.5,.5),t.sprite("titleNeo",14+4*o,4-3*l+12),t.font("Press Start 2P",8),t.color="#fff",r){t.align="center",t.text("FAIR TRADE?",160,148),t.align="left";t.spritePart("effects",136,156+12*(d?1:0),96,24,8,8),t.text("YES",152,164),t.text("NO",152,176)}else t.align="center",this.blinkStart&&t.text("PRESS START",160,164),t.align="left";t.text("TOBIASBU",8,232),t.align="right",t.text("MUSIC BY NILS FESKE",312,232)}}function RandomWhile(t){for(var i;i!==t;)i=scintilla.Random.irange(0,3);return i}function RandomizeFolksParameters(t){for(var i,e,n=0,s=0,o=0,l=t.length,a=l;a--;){switch(i=t[a],0===(e=scintilla.Random.irange(0,3))&&n<2&&(e=RandomWhile(0)),1===e&&s<4&&(e=RandomWhile(1)),2===e&&o<2&&(e=RandomWhile(2)),e){case 0:!0===AntifaControl.fascistMode?i.smartness=scintilla.Random.irange(10,15):i.smartness=scintilla.Random.irange(5,10),i.spd=35,n++;break;case 1:i.smartness=scintilla.Random.irange(15,25),!0===AntifaControl.fascistMode?i.spd=50:i.spd=45,s++;break;case 2:!0===AntifaControl.fascistMode?(i.smartness=scintilla.Random.irange(20,50),i.spd=60):(i.smartness=scintilla.Random.irange(20,35),i.spd=50),o++}i.spdDuration=16/i.spd,i.animMachine.machine.duration=240}!0===AntifaControl.fascistMode&&(t[a=scintilla.Random.irange(0,l)].smartness=100,t[a].spd=75,t[a].spdDuration=16/i.spd)}function RandomizeSpawnPoint(t,i){for(var e,n,s,o=!1,l=t.length;;){if(o=!1,n=scintilla.Random.irange(0,l),0!==i.length)for(s=0;s<i.length;s++)if(i[s]===n){o=!0;break}if(!1===o){e=t.get(n),i.push(n);break}}return e}function InstantiateFolks(t,i,e,n,s){var o,l,a=[];void 0===n&&(n=-1);for(var h=0;h<MAX_FOLKS;h++)n!==h&&((o=t.entity.create(Folk)).animMachine.machine="folk_"+h.toString(),l=RandomizeSpawnPoint(i,e),o.Setup(l.x+s,l.y,h),a.push(o));RandomizeFolksParameters(a),Environment.folks=a}function CreateFolkPlayer(t,i,e,n){var s=t.entity.create(FolkPlayer),o=scintilla.Random.irange(0,MAX_FOLKS);s.animMachine.machine="folk_"+o.toString(),s.folkIDName="_"+o.toString(),s.id=o;var l=RandomizeSpawnPoint(i,e);return s.Setup(l.x+n,l.y),s.animMachine.machine.duration=s.spdDuration/2*1e3,s}function CommonGameEndingEventsUpdate(t,i,e,n){switch(t){case-2:this.tParam=scintilla.Ease.in.cut(0,1,i,4);break;case 1e3:var s=i/.85;1<=s&&(s=1),this.bgm.volume=scintilla.Math.lerp(.3,0,s)}}function CommonGameEndingEventsEnd(t,i){switch(t){case-3:i.eventDuration=1;break;case 999:this.transition.in(),i.eventDuration=2,i.waitForEnd=!1;break;case 1e3:case 1001:this.audio.stopAll(!0),this.scene.set("title")}}function GameEnding(t){this.onEventEnd=null,this.onEventUpdate=null,this.context=t,this.currentEvent=0,this.active=!1,this.eventTimer=0,this.eventDuration=1,this.waitForEnd=!1,this.t=0;var n=!1,s=!0;this.reset=function(){this.onEventEnd=null,this.onEventUpdate=null,this.currentEvent=-3,this.active=!1,this.eventTimer=0,this.eventDuration=1,s=!(n=!1)},this.update=function(t){this.active&&(this.eventTimer+=t,this.t=this.eventTimer/this.eventDuration,this.eventTimer>=this.eventDuration&&(this.eventTimer=this.eventDuration,this.t=1,n=!0),!0===s&&CommonGameEndingEventsUpdate.call(this.context,this.currentEvent,this.t,t,this),null!==this.onEventUpdate&&this.onEventUpdate.call(this.context,this.currentEvent,this.t,t,this),!0===n&&!1===this.waitForEnd&&this.nextEvent())},this.start=function(){this.active=!0,this.currentEvent=-3,this.eventDuration=1.5,this.eventTimer=0,s=!(n=!1),this.waitForEnd=!1},this.end=function(){this.currentEvent=999,this.eventDuration=10,n=!(s=!0),this.eventTimer=0,this.waitForEnd=!1},this.nextEvent=function(t){var i=this.currentEvent,e=i+1;void 0!==t&&(e=t),e!==i&&(this.currentEvent=e,!(this.waitForEnd=!1)===s?(CommonGameEndingEventsEnd.call(this.context,i,this),0<=e&&e<999&&(s=!1)):null!==this.onEventEnd&&this.onEventEnd.call(this.context,i,this),this.t=0,this.eventTimer=0,n=!1)}}function FascistUpdate(t){if(0===Environment.endGame){var i=Environment.player;!0===AntifaControl.peace?0===this.onTribeArea?Environment.largeTribeArea.intersects(i.x,i.y,8,8)&&(this.onTribeArea=1,i.reachTheTribe=!0):1<=this.onTribeArea&&(1===this.onTribeArea?Environment.tribeArea.intersects(i.x,i.y,8,8)&&(this.onTribeArea=2):(this.peacefulTime+=t,30<=this.peacefulTime&&(Environment.endGame=1))):(0===Environment.folks.length&&(Environment.endGame=2),IsFolksCulled(this.camera)?(!1===this.lastCulledCheck&&(this.lastCulledCheck=!0,this.peacefulTime=0),this.peacefulTime+=t,10<=this.peacefulTime&&(Environment.endGame=2)):this.lastCulledCheck=!1),i.tile.x<=-1&&(Environment.folks.length===MAX_FOLKS?Environment.endGame=6:Environment.endGame=2)}else 0<Environment.endGame&&!1===this.gameEnded&&(0===AntifaControl.naziCount&&(this.toSymbol=2,this.currentSymbol=2,this.fromSymbol=2,this.noSymbols=!0,AntifaControl.activeSymbolBar=!0),2===Environment.endGame?this.endingImage="fuck_fascist":1===Environment.endGame?(this.endingImage="hand_shaking",this.symbolFrame=quadSymbolFrame):6===Environment.endGame&&(this.endingImage="hat",this.symbolFrame=quadSymbolFrame),this.circleCuts=360/(4*this.toSymbol)*scintilla.Math.toRadian,this.gameEnded=!0,this.peacefulTime=0,this.endingControl.start())}function AntifaUpdate(t){if(!1===this.gameEnded){var i=!1;0===Environment.endGame&&!0===Environment.player.dying&&(i=!0,this.endingImage="cocar",Environment.endGame=4),5===Environment.endGame&&(this.endingImage="revolution",i=!0),!0===i&&(this.currentSymbol=this.toSymbol,this.symbolFrame=flagSymbolFrame,this.noSymbols=!1,this.circleCuts=360/this.toSymbol*scintilla.Math.toRadian,this.gameEnded=!0,this.peacefulTime=0,this.endingControl.start())}}function GameUI(t){var i=this.endingControl.currentEvent;if(0<this.currentSymbol){var e=5,n=!1;!0===this.gameEnded&&(this.noSymbols&&(e=-8),n=!(i<0));for(var s,o,l=0,a=SYMBOL_START_ANGLE,h=0;h<this.currentSymbol*this.symbolMultiplier;h++)l=this.blinkSymbolTrigger-h%2==0?0:1,!1===n?t.spritePart("effects",2+10*h,e-l,this.symbolFrame.x,this.symbolFrame.y+8*l,8,8):(i<=0?(s=scintilla.Math.lerp(2+10*h,160+Math.cos(a)*SYMBOL_RADIUS,this.peacefulTime),o=scintilla.Math.lerp(e,120+Math.sin(a)*SYMBOL_RADIUS,this.peacefulTime)):(s=160+Math.cos(a)*SYMBOL_RADIUS,o=120+Math.sin(a)*SYMBOL_RADIUS),2===Environment.endGame?i<=0?t.spritePart("effects",s,o-l,this.symbolFrame.x,this.symbolFrame.y+8*l,8,8):t.spritesheet("dol_to_naz_"+l.toString(),s,o-l,this.symbolFrameIndex):this.noSymbols?t.spritesheet("rot_quad",s,o-l,l):t.spritePart("effects",s,o-l,this.symbolFrame.x,this.symbolFrame.y+8*l,8,8),a+=this.circleCuts)}!0===this.gameEnded&&3<=i&&(t.font("Press Start 2P",7,"normal"),t.text(this.endFirstText,160,16,"white","center"),4<=i&&(t.text(this.endSecText,160,26,"white","center"),5<=i&&null!==this.endThrText&&t.text(this.endThrText,160,228,"white","center"),t.alpha=this.tParam3,t.spritesheet(this.endingImage,160,120,this.blinkEndingImageTrigger?0:1,.5,.5),t.alpha=1))}function GameEndingControlEventUpdate(t,i,e,n){if(0<Environment.endGame){switch(t){case 0:this.peacefulTime=i;break;case 1:this.tParam2+=e/.24,1<=this.tParam2&&(this.tParam2=0,this.symbolFrameIndex+=1,4<=this.symbolFrameIndex&&(this.symbolFrameIndex=3,n.nextEvent(2)))}4<=t&&1!==this.tParam3&&(1<=this.tParam2?(this.tParam2=1,this.tParam3=1):(this.tParam2+=e,this.tParam3=scintilla.Ease.in.cut(0,1,this.tParam2,5))),5<=t&&t<1e3&&this.key.pressed(scintilla.KeyCode.Enter)&&n.nextEvent(1e3)}}function GameControlEndingEventEnd(t,i){switch(t){case 0:this.tParam2=0,2===Environment.endGame?i.waitForEnd=!0:(i.waitForEnd=!1,i.nextEvent(2));break;case 2:this.endThrText=null,1===Environment.endGame?(this.endFirstText="THIS MAY BE AN ANSWER.",this.endSecText="WILL IT NOT ENSURE OTHER FASCISM INSTANCES?"):2===Environment.endGame?(this.endSecText="HERE IS A GIFT FOR YOU:",0===AntifaControl.naziCount&&(this.endFirstText="TRYING TO KILL PEOPLE?"),0<AntifaControl.naziCount&&AntifaControl.naziCount<=2?this.endFirstText="KILLING PEOPLE ISN'T COOL!":2<AntifaControl.naziCount&&AntifaControl.naziCount<=4?this.endFirstText="YOU'RE A FASCIST!":5<=AntifaControl.naziCount&&(this.endFirstText="YOU'RE A FUCKING FASCIST!")):4===Environment.endGame?(this.endFirstText="TO DIE FIGHTING FOR THE MOST BASIC OF RIGHTS",this.endSecText="STILL IS A REALITY.",this.endThrText="THE FIGHT CONTINUES..."):5===Environment.endGame?(this.endFirstText="YOUR LAND AND YOUR PEOPLE HAS BEEN DESTROYED.",this.endSecText="ENOUGH WITH UNFAIR TRADES!",this.endThrText="IT'S TIME TO FIGHT FASCISM!"):6===Environment.endGame&&(this.endFirstText="YOU ABANDONED THESE DEMANDS",this.endSecText="BUT THE PAST TOO?"),i.duration=.5;break;case 5:i.end()}}function SceneGame(){this.bgm=null,this.blinkSymbolTrigger=!1,this.blinkSymbolTime=0,this.symbolFrame=null,this.symbolFrameIndex=0,this.symbolBarTime=0,this.currentSymbol=0,this.fromSymbol=0,this.toSymbol=0,this.circleCuts=0,this.symbolMultiplier=0,this.noSymbols=!1,this.peacefulTime=0,this.tParam=0,this.tParam2=0,this.tParam3=0,this.endFirstText="",this.endSecText="",this.endThrText=null,this.endingControl=new GameEnding(this),this.endingImage=null,this.blinkEndingImageTimer=0,this.blinkEndingImageTrigger=!1,this.onTribeArea=0,this.lastCulledCheck=!1,this.gameEnded=!1,this.start=function(){this.reset(),this.transition.out(),this.events.subscribeOnce("transition_end",function(){Environment.endGame=0}),this.bgm=this.audio.play("gameMusic",.3,!0);var t=(!0===AntifaControl.fascistMode?this.create.tilemap("tilemap"):this.create.tilemap("tilemap_long")).modules.get("render");Environment.map=t,Environment.mapColliderLayer=t.getTileLayer("GameLayer"),Environment.mapColliderUpperLayer=t.getTileLayer("UpperLayer");var i=this.cache.tilemap.get("tilemap"),e=0,n=i.getObjectsLayer("FolkSpawn");Environment.safePoints=i.getObjectsLayer("SafePoints").objects,!0===AntifaControl.fascistMode?(Environment.largeTribeArea=i.getObjectsLayer("FolkTribe").objects.at(0),Environment.tribeArea=i.getObjectsLayer("FolkTribe").objects.at(1)):(Environment.blockingPaths=t.getObjectsLayer("BlockedPaths").objects,e=-224),PathFinder.map=t,PathFinder.collisionPredicate=FolkPathFindCollisionTest;var s=null,o=n.objects,l=-1,a=[];this.endingControl.onEventEnd=GameControlEndingEventEnd,this.endingControl.onEventUpdate=GameEndingControlEventUpdate,!0===AntifaControl.fascistMode?(s=this.entity.create(Bugreiro),this.symbolMultiplier=4,this.symbolFrame=dollarSymbolFrame,folkLimit.xMin=26,folkLimit.xMax=35):(this.symbolFrame=flagSymbolFrame,this.symbolMultiplier=1,folkLimit.xMin=10,folkLimit.xMax=31,l=(s=CreateFolkPlayer(this,o,a,e)).id,Environment.ai=this.entity.create(BugreiroAI)),Environment.player=s,InstantiateFolks(this,o,a,l,e)},this.reset=function(){Environment.reset(),AntifaControl.reset(),this.endingControl.reset(),this.pool.has("bullet")||this.pool.create("bullet",Bullet,10),this.pool.has("bullet_efx")||this.pool.create("bullet_efx",ShootEffect,10),this.pool.has("explosion")||this.pool.create("explosion",BulletExplosion,10),this.gameEnded=!1,this.tParam=0,this.tParam2=0,this.tParam3=0,this.noSymbols=!1,this.currentSymbol=0,this.fromSymbol=0,this.toSymbol=0,this.symbolBarTime=0,this.symbolFrameIndex=0,this.blinkEndingImageTimer=0,this.blinkEndingImageTrigger=!1,this.peacefulTime=0,this.onTribeArea=0,this.lastCulledCheck=!1},this.update=function(t){!0===AntifaControl.activeSymbolBar&&(this.blinkSymbolTime+=t,this.symbolBarTime+=t/.25,1<this.symbolBarTime&&(this.symbolBarTime=1),.2<=this.blinkSymbolTime&&(this.blinkSymbolTime=0,this.blinkSymbolTrigger=!this.blinkSymbolTrigger,!0===AntifaControl.fascistMode?AntifaControl.naziCount>this.currentSymbol&&(this.fromSymbol=this.currentSymbol,this.toSymbol=AntifaControl.naziCount,this.symbolBarTime=0):Environment.player.tile.x>=FPLAYER_TILE_START&&(this.fromSymbol=this.currentSymbol,this.toSymbol=Math.round(scintilla.Math.lerp(0,32,(Environment.player.tile.x-FPLAYER_TILE_START)/FPLAYER_TILE_MAX)),32<this.toSymbol&&(this.toSymbol=32),this.symbolBarTime=0)),this.currentSymbol=scintilla.Math.lerp(this.fromSymbol,this.toSymbol,this.symbolBarTime),!1===AntifaControl.fascistMode&&(this.currentSymbol=Math.round(this.currentSymbol))),!0===this.gameEnded&&(4<=this.endingControl.currentEvent&&(this.blinkEndingImageTimer+=t,.48<this.blinkEndingImageTimer&&(this.blinkEndingImageTimer=0,this.blinkEndingImageTrigger=!this.blinkEndingImageTrigger)),this.endingControl.update(t)),!0===AntifaControl.fascistMode?(CameraFollowBugreiro(this.camera,Environment.player),FascistUpdate.call(this,t)):(CameraFollowFolkPlayer(this.camera,Environment.player),AntifaUpdate.call(this,t))},this.gui=function(t){t.color="#000",t.rect(0,0,320,16),!0===this.gameEnded&&(t.alpha=this.tParam,t.rect(0,0,320,240),t.alpha=1),GameUI.call(this,t)}}function ScenePathFindTest(){var o={x:0,y:0},l={x:0,y:1},n={width:30,height:30};this.chain=null,this.depth=40,this.map=[1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,2,2,2,2,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,2,1,1,1,1,1,1,1,1,1,1,1,2,2,2,2,2,2,2,2,2,2,2,2,2,2,1,1,1,1,2,1,1,1,1,1,1,1,1,1,1,1,1,2,1,1,1,1,1,2,1,1,1,1,1,2,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,2,1,1,1,1,1,2,1,1,1,1,1,2,1,1,1,1,1,1,2,2,2,2,2,2,1,1,1,1,1,2,1,1,2,1,1,2,1,1,2,1,1,2,1,1,1,1,1,1,2,1,1,1,1,1,1,1,1,1,1,1,1,1,2,1,1,1,1,1,2,1,1,2,1,1,1,1,1,1,2,1,1,1,1,1,1,1,1,1,1,1,1,1,2,1,1,1,1,1,2,1,1,2,1,1,1,1,1,1,2,1,1,1,2,2,2,2,2,2,2,2,1,1,2,2,2,2,2,2,2,1,1,2,1,1,1,1,1,1,2,1,1,1,1,1,1,1,1,1,1,2,1,1,1,1,1,1,1,1,1,1,1,2,1,1,1,1,1,1,2,1,1,1,1,1,1,1,1,1,1,2,1,1,1,1,1,1,1,1,1,1,1,2,1,1,1,1,1,1,2,1,1,1,1,1,2,2,2,2,2,2,2,2,2,2,1,1,1,2,2,2,2,2,2,1,1,1,1,1,2,1,1,1,1,1,1,1,1,1,1,2,1,1,1,1,1,1,1,1,1,1,1,1,2,1,1,1,1,1,2,1,1,1,1,1,1,1,1,1,1,2,1,1,1,1,1,1,1,1,1,1,1,1,2,1,1,1,2,2,2,2,2,2,2,2,2,2,1,1,1,2,1,1,1,1,1,1,1,1,1,1,1,1,2,1,1,1,1,1,2,1,1,1,1,1,1,1,1,1,1,2,1,1,1,2,2,2,2,2,2,2,1,1,2,1,1,1,1,1,2,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,2,1,1,1,1,1,2,1,1,1,1,1,2,1,1,2,1,1,1,1,2,1,1,1,1,1,1,1,1,1,2,1,1,1,1,1,1,1,1,1,1,1,2,1,1,2,1,1,1,1,2,1,1,1,2,2,2,2,2,2,2,1,1,1,1,1,1,1,1,1,1,1,2,1,1,2,1,1,1,1,2,1,1,1,1,1,1,1,1,1,2,1,1,1,1,1,1,1,1,1,1,1,2,1,1,2,2,2,1,1,2,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,2,1,1,1,1,2,1,1,1,1,1,2,1,1,1,1,2,2,2,2,2,1,1,1,1,1,1,1,1,1,2,1,1,1,1,2,1,1,1,1,1,2,1,1,1,1,1,1,1,1,2,1,1,1,1,1,1,2,2,2,2,1,1,1,1,2,2,2,2,2,2,2,2,2,2,2,2,1,1,1,2,2,2,1,1,1,1,1,1,1,1,1,1,1,1,2,1,1,1,1,1,1,1,1,1,1,2,1,1,1,2,1,1,1,1,1,1,1,1,1,1,1,1,1,1,2,1,1,1,1,1,1,1,1,1,1,2,1,1,1,2,1,1,1,1,1,1,1,1,1,2,1,1,1,1,2,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,2,2,2,2,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,2,1,1,1,1,1,1,1,1,1,2,1,1,1,1,1,1,1,1,1,1,1,1,2,2,2,2,2,2,2,2,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1],this.getTile=function(t,i){var e=t+i*n.width;return this.map[e]},this.start=function(){this.randomize();var e=this;PathFinder.map=n,PathFinder.collisionPredicate=function(t,i){return 2===e.getTile(t,i)},this.chain=PathFinder.FindPath(o,l,this.depth)};this.randomize=function(){for(var t,i,e=!0;e;)if(t=scintilla.Random.irange(0,30),i=scintilla.Random.irange(0,30),2!==this.getTile(t,i)){l.x=t,l.y=i,e=!1;break}},this.update=function(){this.key.pressed(scintilla.KeyCode.Enter)&&(this.randomize(),console.log(l.x+" "+l.y),this.chain=null,this.chain=PathFinder.FindPath(o,l,this.depth))},this.gui=function(t){t.color="#824f39";for(var i=0,e=0,n=0;n<900;n++)2===this.map[n]&&t.rect(8*i,8*e,8,8),30<=++i&&(i=0,e++);if(t.color="#eee",null!==this.chain)for(n=1;n<this.chain.length;n++){var s=this.chain[n];t.rect(8*s.x,8*s.y,8,8)}t.color="#3dcc60",t.rect(8*o.x,8*o.y,8,8),t.color="#598de0",t.rect(8*l.x,8*l.y,8,8)}}function CameraFollowFolkPlayer(t,i){var e=i.x-176;e<=0?e=0:LONG_MAP_MAX-144-176<=e&&(e=LONG_MAP_MAX-144-176),t.x=e}function FolkPlayerCollisionTest(t,i,e,n){var s=!1;return void 0!==n&&!0===n&&null!==e.blockedPath&&(s=e.blockedPath.contains(e.destPos.x,e.destPos.y)),!!(CheckMapCollision(t,i)||CollidesWithFolk(t,i,!0)||CollideWith(Environment.ai,t,i)||s)}function FolkPlayer(){this.animMachine=null,this.folkIDName="_",this.blockedPathIndex=0,this.blockedPath=null,this.nextBlockedPath=null,this.isMoving=!1,this.isPlayer=!0,this.dead=!1,this.dying=!1,this.reachCity=!1,this.goToCity=!1,this.chainNode=null,this.navigation=0,this.ChangeState=function(t){void 0===t&&(t=this.dir);var i="folk_",e="";switch(this.dir=t){case 0:case 1:e="side";break;case 2:e="up";break;case 3:e="down"}i+=e+this.folkIDName,this.animMachine.setState(i),!1===this.animMachine.isPlaying&&this.animMachine.play()},this.ActiveMoving=function(t){this.scale.x=t,this.isMoving=!0,this.moveTimer=0,this.oldPos.x=this.x,this.oldPos.y=this.y},this.animationEnd=function(){0!==Environment.endGame&&(this.ChangeState(),this.animMachine.stop())},this.start=function(){CreateTiledEntity(this,50),this.animMachine=this.modules.attach.animMachine(),this.blockedPathIndex=-1,this.nextBlockedPath=Environment.blockingPaths.at(0),this.isPlayer=!0,this.dead=!1,this.dying=!1,this.origin.set(.5,.5),this.spr=this.modules.get("render"),this.spr.depth=3,this.animMachine.stop()},this.update=function(t){if(0===Environment.endGame&&!1===this.dying){if(!1===Environment.reachCity){var i=-this.scene.key.press(scintilla.KeyCode.Left)+this.scene.key.press(scintilla.KeyCode.Right),e=-this.scene.key.press(scintilla.KeyCode.Up)+this.scene.key.press(scintilla.KeyCode.Down);!1===this.isMoving&&(0!==i?(this.hspd=i,this.vspd=0,this.ChangeState(-1===i?0:1),this.ActiveMoving(-i)):0!==e?(this.vspd=e,this.hspd=0,this.ChangeState(-1==e?2:3),this.ActiveMoving(1)):(this.animMachine.stop(),this.isMoving=!1),this.isMoving&&(this.oldTile.x=this.tile.x,this.oldTile.y=this.tile.y,this.toTile.x=this.tile.x+this.hspd,this.toTile.y=this.tile.y+this.vspd,this.destPos.x=Math.round(16*this.toTile.x+8),this.destPos.y=Math.round(16*this.toTile.y+8),WorldToTile(this.destPos.x-8,this.destPos.y-8,this.toTile),FolkPlayerCollisionTest(this.toTile.x,this.toTile.y,this,!1)&&(this.animMachine.stop(),this.isMoving=!1,this.toTile.x=-99,this.toTile.y=-99)))}else{var n;if(!1===this.goToCity){if(!1===this.isMoving)this.goToCity=!0,null!==this.chainNode&&1<this.chainNode.length&&(this.navigation=1,n=ActivePathNodeMovement(this,this.chainNode[1]),this.ChangeState(n))}else TileMovementThroughPathNode(this.chainNode,this,t),this.navigation>=this.chainNode.length&&this.EndingGame()}this.isMoving&&!1===this.goToCity&&(this.moveTimer+=t/this.spdDuration,1<=this.moveTimer&&(this.isMoving=!1,this.moveTimer=1),0!==this.hspd&&(this.x=scintilla.Math.lerp(this.oldPos.x,this.destPos.x,this.moveTimer)),0!==this.vspd&&(this.y=scintilla.Math.lerp(this.oldPos.y,this.destPos.y,this.moveTimer)),WorldToTile(this.x-8,this.y-8,this.tile),this.isMoving||(this.x=this.destPos.x,this.y=this.destPos.y,RoundToTile(this),this.oldTile.x=this.tile.x,this.oldTile.y=this.tile.y,this.x>this.nextBlockedPath.x+this.nextBlockedPath.width&&(this.blockedPathIndex++,this.blockedPathIndex<Environment.blockingPaths.size?(this.blockedPath=this.nextBlockedPath,this.nextBlockedPath=Environment.blockingPaths.at(this.blockedPathIndex)):this.blockedPath=this.nextBlockedPath))),!1===Environment.reachCity&&173<=this.tile.x&&(Environment.playerReachedToCity(),this.chainNode=PathFinder.FindPath(this.tile,{x:192,y:6},void 0,FolkPlayerCollisionTest,this))}},this.Setup=function(t,i){this.position.set(t+8,i+8),this.tile=GetTile(this.x-8,this.y-8),this.oldTile.x=this.tile.x,this.oldTile.y=this.tile.y,this.animMachine.stop(),this.dying=!1,this.dead=!1},this.Die=function(){if(!0!==this.dying){this.dying=!0,this.dead=!0,this.animMachine.stop();var t=this.id%2*16,i=16*scintilla.Math.floor(this.id/2);this.spr.setFrame(64+t,0+i,16,16);var e=this.scene.create.sprite("effects","blood",bloodFrame);e.position.set(this.x-8,this.y-8),this.spr.depth=1,e.modules.get("render").depth=0}},this.EndingGame=function(){this.animMachine.stop();var t=this.id%2*16,i=16*scintilla.Math.floor(this.id/2);this.spr.setFrame(64+t,64+i,16,16),Environment.endGame=5}}var VIEW={w:640,h:480},config={width:VIEW.w,height:VIEW.h,camera:{width:320,height:240},parent:"body",debug:!1,fps:60,pixelated:!0,roundPixels:!1,floorTiles:!0},game=new scintilla.Game(config);game.render.layer.add("game"),game.scene.add("logo",SceneLogo),game.scene.add("title",SceneTitle),game.scene.add("game",SceneGame),game.scene.add("test",ScenePathFindTest),game.scene.set("logo");